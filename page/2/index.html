<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|comic sans:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="染心" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="一只奋进的小菜鸟">
<meta property="og:type" content="website">
<meta property="og:title" content="染心">
<meta property="og:url" content="https://lfstefan.github.io/page/2/index.html">
<meta property="og:site_name" content="染心">
<meta property="og:description" content="一只奋进的小菜鸟">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="染心">
<meta name="twitter:description" content="一只奋进的小菜鸟">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://lfstefan.github.io/page/2/"/>





  <title>染心</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>
    <a href="https://github.com/LFstefan"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/567c3a48d796e2fc06ea80409cc9dd82bf714434/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">染心</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Coding Everyday</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://lfstefan.github.io/2018/04/15/Compile JDK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘飞">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="染心">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/04/15/Compile JDK/" itemprop="url">
                  Compile JDK
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-15T12:21:25+08:00">
                2018-04-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JDK/" itemprop="url" rel="index">
                    <span itemprop="name">JDK</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/15/Compile JDK/" class="leancloud_visitors" data-flag-title="Compile JDK">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="动手编译JDK"><a href="#动手编译JDK" class="headerlink" title="动手编译JDK"></a>动手编译JDK</h1><blockquote>
<p>README-builds.html，每一份源码内均存在的编译指南，英语基础好的童鞋可直接参考该文档，比起网络上的资源，官方文档始终应该作为第一选择！</p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>如果你是linux操作系统小白，上来就想挑战编译jdk，那么你将会遇到重重困难，但是这同时也是一个非常好的学习机会，因为你会突然间接触到非常多的新知识，过程中的每一个坑，每一次失败都将成为你进步的垫脚石，期间需要你非常耐心的去面对和处理每一个问题，分析其原因并总结经验教训，切记不可急躁，你所花费的每一分钟都将会有所收获，急躁只会打乱你的思考，导致考虑问题的轨道产生偏差，从而绕其弯路，文章只会告诉你如何编译jdk，但不会告诉你怎么操作才能看到最后的成功标志，需要你自己去一遍思考一遍了解为何这样做，祝各位旅途愉快，到达成功的终点。（大佬们请自动忽略我的废话，直接找寻你们的目标信息即可）</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li>材料准备</li>
<li>编译jdk</li>
<li>过程总结</li>
<li>涉及知识清单</li>
</ul>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="材料准备"><a href="#材料准备" class="headerlink" title="材料准备"></a>材料准备</h3><ul>
<li><p>linux操作系统</p>
<ul>
<li>系统中常用的工具及依赖自行安装，如不清楚编译jdk需要哪些依赖及工具可参考附录</li>
<li>系统网络状态正常，因为编译中途会涉及到下载相关依赖</li>
<li>openjdk7，用于后续的jdk编译（这里的jdk不同于后续待编译的jdk，这里jdk是我们平时正常使用的jdk，因为jdk各个组成部分有的是用c/c++写的，有的是用java写的，所以后续编译java代码时需要用到）</li>
<li><p>openjdk源码（此为我们后续编译的jdk源代码，版本自行选择，这里使用的7）</p>
<ul>
<li>获取 OpenJDK 源码大致有两种方式</li>
<li>通过 Mercurial 代码版本管理工具从 Repository 中直接取得源码，这就需要我们先安装工具Mercurial，安装过程自行查阅资料。</li>
</ul>
<blockquote>
<p>注意：使用Mercrial工具下载源码时，结果可能由于网络原因导致源码文件有所缺失，从而后续命令失败。</p>
</blockquote>
<ul>
<li>从网站上下载： <a href="http://download.java.net/openjdk/jdk7/promoted/b147/openjdk-7-fcs-src-b147-27_jun_2011.zip" target="_blank" rel="external">http://download.java.net/openjdk/jdk7/promoted/b147/openjdk-7-fcs-src-b147-27_jun_2011.zip</a> </li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="编译jdk"><a href="#编译jdk" class="headerlink" title="编译jdk"></a>编译jdk</h3><ul>
<li><p>环境变量配置</p>
<ul>
<li><p>编辑环境变量命令：vi /etc/profile</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">语言选项,这个必须设置,否则编译好后会出现一个HashTable的NPE错</div><div class="line">export LANG=C</div><div class="line">Bootstrap JDK的安装路径。必须设置</div><div class="line">export ALT_BOOTDIR=/usr/local/java/jdk1.8.0_101 </div><div class="line"></div><div class="line">允许自动下载依赖</div><div class="line">export ALLOW_DOWNLOADS=true</div><div class="line"></div><div class="line">并行编译的线程数,设置为和CPU内核数量一致即可</div><div class="line">export HOTSPOT_BUILD_J0BS=6</div><div class="line">export ALT_PARALLEL_COMPILE_JOBS=6 </div><div class="line"></div><div class="line">比较本次build出来的映像与先前版本的差异。这对我们来说没有意义, </div><div class="line">必须设置为false,香则sanity检查会报缺少先前版本JDK的映像的错误提示。 </div><div class="line">如桌已经设置dev或者DEV_ONLY=true,这个不显式设置也行</div><div class="line">export SKIP_COMPARE_IMAGES=true</div><div class="line"></div><div class="line">使用预编译头文件,不加这个编译会更慢一些</div><div class="line">export USE_PRECOMPILED_HEADER=true</div><div class="line"></div><div class="line">要编译的内容</div><div class="line">export BUILD_LANGTOOLS=true</div><div class="line">export BUILD_JAXP=false</div><div class="line">export BUILD_JAXWS=fa1se</div><div class="line">export BUILD_CORBA=false</div><div class="line">export BUILD_HOTSPOT=true</div><div class="line">export BUILD_JDK=true</div><div class="line"></div><div class="line">要编译的版本</div><div class="line">export SKIP_DEBUG_BUILD=false</div><div class="line">export SKIP_FASTDEBUG_BUILD=true</div><div class="line">export DEBUG_NAME=debug</div><div class="line"></div><div class="line">把它设置为false可以避开javaws和浏览器Java插件之类的部分的build</div><div class="line">BUILD_DEPLOY=false</div><div class="line"></div><div class="line">把它设置为false就不会build出安装包。因为安装包里有些奇怪的依赖, </div><div class="line">但即便不build出它也已经能得到完整的JDK映像,所以还是别build它好了</div><div class="line">BUILD_INSTALL=false</div><div class="line"></div><div class="line">编译结果所存放的路径</div><div class="line">export ALT_OUTPUTDIR=/root/openjdk7/build</div><div class="line"></div><div class="line">这两个环境变量必须去掉,不然会有很诡异的事情发生（我没有具体查过这些 "诡异的</div><div class="line">事情” ,Makefile脚本裣查到有这2个变量就会提示警告)</div><div class="line">unset JAVA_HOME</div><div class="line">unset CLASSPATH</div><div class="line">make 2&gt;&amp;1 | tee $ALT_OUTPUTDIR/build.log</div></pre></td></tr></table></figure>
</li>
<li><p>生效环境变量命：source /etc/profile</p>
</li>
</ul>
</li>
<li><p>编译</p>
<ul>
<li>编译前的检测：进入到openjdk源码目录下执行命令：make sanity检测编译环境是否可行，出现Sanity check passed.结果表示测试通过可以进行编译，否则根据报错进行修改。</li>
<li>开始编译：在openjdk源码目录下执行命令：make开始编译，过程时间长短由你所配置的环境变量有关，本次时长大约十三分钟，出现以下命令时表示编译成功。  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">成功标志：</div><div class="line">-- Build times ----------</div><div class="line">Target all_product_build</div><div class="line">Start <span class="number">2018</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">08</span></div><div class="line">End   <span class="number">2018</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">54</span></div><div class="line"><span class="number">00</span>:<span class="number">00</span>:<span class="number">05</span> corba</div><div class="line"><span class="number">00</span>:<span class="number">00</span>:<span class="number">05</span> hotspot</div><div class="line"><span class="number">00</span>:<span class="number">00</span>:<span class="number">03</span> jaxp</div><div class="line"><span class="number">00</span>:<span class="number">00</span>:<span class="number">05</span> jaxws</div><div class="line"><span class="number">00</span>:<span class="number">12</span>:<span class="number">25</span> jdk</div><div class="line"><span class="number">00</span>:<span class="number">00</span>:<span class="number">03</span> langtools</div><div class="line"><span class="number">00</span>:<span class="number">12</span>:<span class="number">46</span> TOTAL</div><div class="line">-------------------------</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>编译结果</p>
<ul>
<li>进入存放编译结果目录（环境变量已配置）/root/openjdk7/build下的j2sdk-image目录</li>
<li>cd /root/openjdk7/build/j2sdk-image</li>
<li>更换JAVA_HOME路径（j2sdk-image路径下的内容就和我们平时用的jdk内容大致一样）</li>
<li>export JAVA_HOME=/root/openjdk7/build/j2sdk-image</li>
<li>export PATH=$PATH:$JAVA_HOME/bin</li>
<li>检测编译结果</li>
<li>java -version</li>
<li>出现版本号等信息说明编译成功可用</li>
</ul>
</li>
<li><p>运行编译后的虚拟机：</p>
<ul>
<li>进入目录/root/openjdk7/build/hotspot/outputdir/linux_amd64_compiler2/product</li>
<li>修改文件env.sh：vi env.sh</li>
<li>LD_LIBRARY_PATH=.:${JAVA_HOME}/jre/lib/amd64/native_threads:${JAVA_HOME}/jre/lib/amd64:（有则不管，无则加入）</li>
<li>export LD_LIBRARY_PATH（有则不管，无则加入）</li>
<li>修改JAVA_HOME路径为编译后的jdk，即JAVA_HOME=/root/openjdk7/build/j2sdk-image</li>
<li>运行命令：source ./env.sh和./gamma -version</li>
<li>出现结果如下说明成功<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Using java runtime at: /root/openjdk7/build/j2sdk-image/jre</div><div class="line">openjdk version <span class="string">"1.7.0-internal"</span></div><div class="line"><span class="function">OpenJDK Runtime <span class="title">Environment</span> <span class="params">(build <span class="number">1.7</span><span class="number">.0</span>-internal-openjdk_2017_05_13_11_17-b00)</span></span></div><div class="line">OpenJDK 64-Bit Server <span class="title">VM</span> <span class="params">(build <span class="number">24.80</span>-b07, mixed mode)</span></div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="过程总结"><a href="#过程总结" class="headerlink" title="过程总结"></a>过程总结</h3><ul>
<li>首先linux系统一定要够熟练，基本命令的使用，操作系统的了解，包括jvm和jdk的组成生态环境，都对你的整个编译过程有很大的帮助</li>
<li>前面提到过编译过程中会有相关依赖的下载（总共有三个，分别为：jaxp145_01.zip，jdk7-jaxws2_2_4-b03-2011_05_27.zip ，jdk7-jaf-2010_08_19.zip），但是实际上下载会失败，将链接地址拷贝出来到网页是可以下载的，但是编译过程中不行，本次编译实现两种解决方案，一种是将下载链接地址换成其他例如，网盘，七牛云等，一种是自行下载好放入相应文件夹中<ul>
<li>方法一需修改配置文件 其一位置为：/root/openjdk7/jaxp/jaxp.properties，其二位置为：/root/openjdk7/jaxws/jaxws.properties</li>
<li>将上述配置文件中jaxws_src.master.bundle.url.base=<a href="http://download.java.net/glassfish/components/jax-ws/openjdk/jdk7后面的url地址换成自己的地址即可" target="_blank" rel="external">http://download.java.net/glassfish/components/jax-ws/openjdk/jdk7后面的url地址换成自己的地址即可</a></li>
<li>方法二将以下三个文件下载后置于OpenJDK解压后根目录下的drop目录下，并在环境变量中加入配置：export ALT_DROPS_DIR=/usr/local/src/openjdk7/drop # 注意目录Path<ul>
<li><a href="https://netix.dl.sourceforge.net/project/jdk7src/input-archives/jdk7-jaf-2010_08_19.zip" target="_blank" rel="external">https://netix.dl.sourceforge.net/project/jdk7src/input-archives/jdk7-jaf-2010_08_19.zip</a></li>
<li><a href="http://download.java.net/glassfish/components/jax-ws/openjdk/jdk7/jdk7-jaxws2_2_4-b03-2011_05_27.zip" target="_blank" rel="external">http://download.java.net/glassfish/components/jax-ws/openjdk/jdk7/jdk7-jaxws2_2_4-b03-2011_05_27.zip</a> </li>
<li><a href="http://download.java.net/jaxp/1.4.5/jaxp145_01.zip" target="_blank" rel="external">http://download.java.net/jaxp/1.4.5/jaxp145_01.zip</a></li>
</ul>
</li>
</ul>
</li>
<li>错误：Error: time is more than 10 years from present: 1136059200000<ul>
<li>需要修改源码目录中的一个文件，这个文件是<openjdk源码目录>/jdk/src/share/classes/java/util/CurrencyData.properties。</openjdk源码目录></li>
<li>我们需要做的是把文件中以下的时间改为10年内的一个时间： </li>
</ul>
</li>
<li>错误：JAVA_HOME must point to a valid JDK/JRE to run gamma<ul>
<li>解决：export JAVA_HOME=/root/openjdk7/build/j2sdk-image（使用我们刚刚自己编译的jdk）</li>
<li>echo $JAVA_HOME</li>
</ul>
</li>
<li>编译jvmg版本的jdk。<ul>
<li>make jvmg jvmg1 2&gt;&amp;1 | tee $ALT_OUTPUTDIR/build.log</li>
<li>上面我的命令只是编译jvmg版的hotspot。所以除了jvmg目录，其他目录下是没有hotspot的。</li>
<li>最后通过gamma启动器来启动hotspot。</li>
</ul>
</li>
</ul>
<h3 id="知识扩展"><a href="#知识扩展" class="headerlink" title="知识扩展"></a>知识扩展</h3><ul>
<li>MD5 CheckSum：在一些场景中，比如文件传输（如插件、固件升级包等），MD5 CheckSum的作用就是用于检查文件完整性，检测文件是否被恶意篡改。编译过程中的依赖下载就用到了该技术，在配置文件/root/openjdk7/jaxp/jaxp.properties，其二位置为：/root/openjdk7/jaxws/jaxws.properties中可以看到该字段配置</li>
</ul>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="编译涉及依赖及工具安装命令："><a href="#编译涉及依赖及工具安装命令：" class="headerlink" title="编译涉及依赖及工具安装命令："></a>编译涉及依赖及工具安装命令：</h3><blockquote>
<p>yum install build-essential gawk m4 openjdk-6-jdk libasound2-dev libcups2-dev libxrender-dev xorg-dev xutils-dev xllproto-print-dev binutils libmotif3 libmotif-dev ant</p>
</blockquote>
<h3 id="各个依赖工具作用："><a href="#各个依赖工具作用：" class="headerlink" title="各个依赖工具作用："></a>各个依赖工具作用：</h3><ul>
<li>build-essential：作用是提供编译程序必须软件包的列表信息也就是说 编译程序有了这个软件包它才知道 头文件在哪 才知道库函数在哪还会下载依赖的软件包   最后才组成一个开发环境</li>
<li>gawk (gnu awk) ：linux下查找替换文本工具按行(或者其他文本单元)搜索文件内容,包含一个匹配模式。当有文本行匹配，awk在此行进行特别的操作。Program告诉awk该去做什么;</li>
<li>m4 ：将输入拷贝到输出,同时将宏展开. 宏可以是内嵌的也可以是用户定义的. 除了可以展开宏,m4还有一些内建的函数,用来引用文件,执行Unix命令,整数运算,文本操作,循环等. m4既可以作为编译器的前端也可以单独作为一个宏处理器。</li>
<li>libasound2-dev： 这是Advanced Linux Sound Architecture (ALSA)相关的依赖。 </li>
<li>libcups2-dev： 这是Common UNIX Printing System (CUPS)相关的依赖。 </li>
<li>binutils：GNU binutils是一组二进制工具集。包括：addr2line ar gprof nm objcopy objdump ranlib size strings strip. 本文归纳他们的常用法。ar用于建立、修改、提取档案文件(archive)。archive是一个包含多个被包含文件的单一文件（也称之为库文件），其结构保证了可以从中检索并得到原始的被包含文件（称之为archive中的member）。member的原始文件内容、模式（权限）、时间戳、所有者和组等属性都被保存在 archive中。member被提取后，他们的属性被恢复到初始状态。</li>
<li>待补充。。。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://lfstefan.github.io/2018/04/15/初识REST/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘飞">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="染心">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/04/15/初识REST/" itemprop="url">
                  初识REST
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-15T12:21:25+08:00">
                2018-04-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/REST/" itemprop="url" rel="index">
                    <span itemprop="name">REST</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/15/初识REST/" class="leancloud_visitors" data-flag-title="初识REST">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="初识REST"><a href="#初识REST" class="headerlink" title="初识REST"></a>初识REST</h1><ul>
<li>rest是什么，来源，起因，未来</li>
<li>restAPI接口设计<ul>
<li>get方法，接口中添加注解@GET，实现类无需再添加注解，安全（读取资源不会对其状态做改动），幂等（外系统对接口的多次访问，得到的资源状态是一致的）</li>
<li>资源命名，面向资源，名词为主（rpc，面向动作，动词为主）</li>
<li>head，option方法与get方法类似</li>
<li>put，http写请求方法，用于更新或添加资源，幂等，不安全（凡是涉及写请求的http方法都不是安全的）</li>
<li>delete，幂等，</li>
<li>post，不幂等，不安全，rpc中所有写请求操作均使用该方法，rest中只用来添加资源</li>
</ul>
</li>
</ul>
<p>jersey的AOP功能：HK2依赖实现，无需配置，实现接口即可</p>
<ul>
<li><p>rest和rpc的区别<br>rest的web服务提供的方法信息存在http方法中<br>rpc的web服务提供的方法信息存在http信封中</p>
</li>
<li><p>rest和soap的区别<br>Stack Overflow上看到一个回答觉得很到位</p>
<blockquote>
<p>SOAP and REST can’t be compared directly, since the first is a protocol (or at least tries to be) and the second is an architectural style. This is probably one of the sources of confusion around it, since people tend to call REST any HTTP API that isn’t SOAP.<br>Pushing things a little and trying to establish a comparison, the main difference between SOAP and REST is the degree of coupling between client and server implementations. A SOAP client works like a custom desktop application, tightly coupled to the server. There’s a rigid contract between client and server, and everything is expected to break if either side changes anything. You need constant updates following any change, but it’s easier to ascertain if the contract is being followed.<br>A REST client is more like a browser. It’s a generic client that knows how to use a protocol and standardized methods, and an application has to fit inside that. You don’t violate the protocol standards by creating extra methods, you leverage on the standard methods and create the actions with them on your media type. If done right, there’s less coupling, and changes can be dealt with more gracefully. A client is supposed to enter a REST service with zero knowledge of the API, except for the entry point and the media type. In SOAP, the client needs previous knowledge on everything it will be using, or it won’t even begin the interaction. Additionally, a REST client can be extended by code-on-demand supplied by the server itself, the classical example being JavaScript code used to drive the interaction with another service on the client-side.<br>I think these are the crucial points to understand what REST is about, and how it differs from SOAP:<br>REST is protocol independent. It’s not coupled to HTTP. Pretty much like you can follow an ftp link on a website, a REST application can use any protocol for which there is a standardized URI scheme.<br>REST is not a mapping of CRUD to HTTP methods. Read this answer for a detailed explanation on that.<br>REST is as standardized as the parts you’re using. Security and authentication in HTTP are standardized, so that’s what you use when doing REST over HTTP.<br>REST is not REST without hypermedia and HATEOAS. This means that a client only knows the entry point URI and the resources are supposed to return links the client should follow. Those fancy documentation generators that give URI patterns for everything you can do in a REST API miss the point completely. They are not only documenting something that’s supposed to be following the standard, but when you do that, you’re coupling the client to one particular moment in the evolution of the API, and any changes on the API have to be documented and applied, or it will break.<br>REST is the architectural style of the web itself. When you enter Stack Overflow, you know what a User, a Question and an Answer are, you know the media types, and the website provides you with the links to them. A REST API has to do the same. If we designed the web the way people think REST should be done, instead of having a home page with links to Questions and Answers, we’d have a static documentation explaining that in order to view a question, you have to take the URI stackoverflow.com/questions/<id>, replace id with the Question.id and paste that on your browser. That’s nonsense, but that’s what many people think REST is.<br>This last point can’t be emphasized enough. If your clients are building URIs from templates in documentation and not getting links in the resource representations, that’s not REST. Roy Fielding, the author of REST, made it clear on this blog post: REST APIs must be hypertext-driven.<br>With the above in mind, you’ll realize that while REST might not be restricted to XML, to do it correctly with any other format you’ll have to design and standardize some format for your links. Hyperlinks are standard in XML, but not in JSON. There are draft standards for JSON, like HAL.<br>Finally, REST isn’t for everyone, and a proof of that is how most people solve their problems very well with the HTTP APIs they mistakenly called REST and never venture beyond that. REST is hard to do sometimes, especially in the beginning, but it pays over time with easier evolution on the server side, and client’s resilience to changes. If you need something done quickly and easily, don’t bother about getting REST right. It’s probably not what you’re looking for. If you need something that will have to stay online for years or even decades, then REST is for you.</id></p>
</blockquote>
</li>
<li><p>rest和mvc的区别</p>
</li>
</ul>
<ul>
<li>rest应用开发demo</li>
<li>实体类 @XmlRootElement定义类，@XmlElementWapper等其他注解</li>
<li>资源路径定义，也就是springMVC中的路径问题</li>
<li>资源类==controller，@Path（”/类路径”），</li>
<li>@Path（”/方法路径”）@GET/@PUT方法类型，@Produce（）返回json需要使用@Produces注解，@Concumer（）接收json，需要使用@Consumes，该注解标注在类上事务，表示该类中所有的方法均遵循该注解配置，一般建议建议将注解标注在接口中，实现显得干净整洁一些</li>
<li>集成spring用的包为jersey-spring</li>
</ul>
<p>这里的jersey是和spring一起使用的，将jersey的webservice交给spring管理。<br>因此容器<servlet-class>这一块，必须选择：com.sun.jersey.spi.spring.container.servlet.SpringServlet而不是org.glassfish.jersey.servlet.ServletContainer</servlet-class></p>
<ul>
<li>体会心得</li>
<li>jaxp标准：包括dom，sax，stax三种解析xml的技术，各不相同，需要手写解析过程</li>
<li>dom：面向文档，加载进内存，映射为树木和节点</li>
<li>sax：事件驱动的流解析技术，监听注册事件，触发回调实现解析</li>
<li>stax拉式流解析技术，相当于sax的时间驱动推送技术，该读取过程可以主动推进当前xml位置的指针而不是被动获得解析中的xml数据</li>
<li>jsxb标准：利用pojo中的注解来实现xml文件的自动解析，免去了手写程序解析xml的过程</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://lfstefan.github.io/2018/04/08/RedisTheory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘飞">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="染心">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/04/08/RedisTheory/" itemprop="url">
                  RedisTheory
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-08T12:21:25+08:00">
                2018-04-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/08/RedisTheory/" class="leancloud_visitors" data-flag-title="RedisTheory">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Redis底层技术实现与原理"><a href="#Redis底层技术实现与原理" class="headerlink" title="Redis底层技术实现与原理"></a>Redis底层技术实现与原理</h1><blockquote>
<p>本篇以《Rdeis设计与实现》为阅读基础，总结提炼其中一些知识点</p>
</blockquote>
<ul>
<li>底层数据结构</li>
<li>内存回收机制</li>
<li>对象共享</li>
<li>单机数据库</li>
<li>RDB持久化</li>
<li>AOF持久化</li>
<li>事件</li>
<li>复制</li>
<li>redis集群</li>
</ul>
<p>&lt;- more -&gt;</p>
<h2 id="基本底层实现"><a href="#基本底层实现" class="headerlink" title="基本底层实现"></a>基本底层实现</h2><h3 id="SDS动态字符串（redis内部自定义字符串）"><a href="#SDS动态字符串（redis内部自定义字符串）" class="headerlink" title="SDS动态字符串（redis内部自定义字符串）"></a>SDS动态字符串（redis内部自定义字符串）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Struct sdshdr&#123; </div><div class="line">Int len;字符串长度，不包括结束符‘/<span class="number">0</span>’ </div><div class="line">Int free;字符串剩余空间，同样不包括结束符 </div><div class="line">Char buf[];字节数组，分配空间时多分配一个为结束符 </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>优势：<ol>
<li>常数时间获取字符串长度（len） </li>
<li>避免了缓冲区溢出（free，先检测free空间是否充足在执行操作） </li>
<li>减少修改字符串带来的内存重分配次数，采用空间预分配，若修改后的sds.len<1mb，则buf的长度等于len*2+1，即len=free（预分配空间等于已使用空间），若sds.len>1MB，则buf的长度等于30MB+1MB+1byte，即len=30MB，free=1MB；同时采用惰性空间释放策略，当缩小字符串长度时，并不是立马释放缩小空间，而是加到free中来供后续为字符串增加长度做准备。 </1mb，则buf的长度等于len*2+1，即len=free（预分配空间等于已使用空间），若sds.len></li>
</ol>
</li>
</ul>
<h3 id="双向链表"><a href="#双向链表" class="headerlink" title="双向链表"></a>双向链表</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Typedef struct listNode&#123; </div><div class="line">Struct listNode *prev; </div><div class="line">Struce listNode *next; </div><div class="line">Void *value; </div><div class="line">&#125;listNode; </div><div class="line"></div><div class="line">Typedef struct list&#123; </div><div class="line">listNode *head;头节点 </div><div class="line">listNode *tail;尾节点 </div><div class="line">Unsigned <span class="keyword">long</span> len;节点数量 </div><div class="line">Void *(*dup) (<span class="keyword">void</span> *ptr);节点值复制函数 </div><div class="line">Void *(*free) (<span class="keyword">void</span> *ptr);节点值释放函数 </div><div class="line"> <span class="keyword">int</span> (*match) (<span class="keyword">void</span> *ptr ,<span class="keyword">void</span> *key);节点值对比函数 </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>特点：<ol>
<li>双向（prev，next），双指针（表头，表尾） </li>
<li>无环，表头的prev和表尾的next均指向null，访问以null为结束 </li>
<li>O（1）获取链表长度 </li>
<li>可保存不同类型的值 </li>
</ol>
</li>
</ul>
<h3 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Typedef struct dictht&#123; </div><div class="line">dicEntry **table;哈希表数组 </div><div class="line">Unsigned <span class="keyword">long</span> size;哈希表大小 </div><div class="line">Unsigned <span class="keyword">long</span> sizemask;哈希表大小掩码，用于计算索引值（=size-<span class="number">1</span>） </div><div class="line">Unsigned <span class="keyword">long</span> used;哈希表已有节点数量 </div><div class="line">&#125; </div><div class="line"></div><div class="line">Typedef struct dicEntry&#123; </div><div class="line"> <span class="keyword">void</span> *key;键 </div><div class="line">Union&#123;值可以有三种类型 </div><div class="line">Void *val;指针 </div><div class="line">Uint64_tu64;无符号整数 </div><div class="line">Int64_ts64;有符号整数 </div><div class="line">&#125;v; </div><div class="line"></div><div class="line">Struct dicEntry *next;下一个哈希表节点，链地址法解决冲突 </div><div class="line"></div><div class="line">&#125;dicEntry;</div></pre></td></tr></table></figure>
<h3 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Typedef struct dict&#123; </div><div class="line">dictType *type;类型特定函数，为用途不同的字典设置不同的类型特定函数，如复制键函数，复制值函数，计算哈希值函数等 </div><div class="line">Void *<span class="keyword">private</span>;为类型特定函数提供参数 </div><div class="line">Dictht ht[<span class="number">2</span>];哈希表两个，正常只用第一个ht[<span class="number">0</span>]，ht[<span class="number">1</span>]在rehash的时候用 </div><div class="line">Int rehashidx;rehash状态判定，rehash不在进行时值为-<span class="number">1</span> </div><div class="line">&#125;dict;</div></pre></td></tr></table></figure>
<ul>
<li>哈希索引值index = hash &amp; dict-&gt;ht[x].sizemask </li>
<li><p>Rehash操作： </p>
<ol>
<li>rehashidx值置为0，表示rehash工作正式开始，为字典的ht[1]分配空间 </li>
<li>如果是扩展操作，ht[1]的大小为第一个大于等于ht[0].used*2的2的n次方幂 </li>
<li>如果是收缩操作，ht[1]的大小为第一个大于等于ht[0].used的2的n次方幂 </li>
<li><p>将ht[0]中的内容重新计算哈希值和索引值迁移到ht[1]中，ht[0]变为空表，然后释放ht[0] </p>
</li>
<li><p>将ht[1]更改为ht[0]，重新创建一个新的表空间ht[1]为下次rehash做准备，rehash工作完成，rehashidx值置为-1 </p>
</li>
<li><p>当数量较为庞大时，rehash过程为渐进式，而不是一次性，将rehash操作均摊到每一次的字典的增删改查操作上 </p>
</li>
</ol>
</li>
</ul>
<h3 id="跳跃表-（有序数据结构，在一个接点中维持有多个指向其他节点的指针，从而实现跳跃性访问节点，可代替平横树）"><a href="#跳跃表-（有序数据结构，在一个接点中维持有多个指向其他节点的指针，从而实现跳跃性访问节点，可代替平横树）" class="headerlink" title="跳跃表-（有序数据结构，在一个接点中维持有多个指向其他节点的指针，从而实现跳跃性访问节点，可代替平横树）"></a>跳跃表-（有序数据结构，在一个接点中维持有多个指向其他节点的指针，从而实现跳跃性访问节点，可代替平横树）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Typedef struct zskiplistNode&#123; </div><div class="line">Struct zskiplistLevel&#123; </div><div class="line">Struct zskiplistNode *forward; </div><div class="line">Unsigned <span class="keyword">int</span> span;跨度，节点间的距离 </div><div class="line">&#125;level[];层，表示一个节点维持有几个指向其他节点的指针，即level数组的个数 </div><div class="line"></div><div class="line">Struct zskiplistNode *backward; </div><div class="line">Double score;保存对象值 </div><div class="line">Robj *obj;保存对象 </div><div class="line">&#125;zskiplistNode;</div></pre></td></tr></table></figure>
<h3 id="整数集合"><a href="#整数集合" class="headerlink" title="整数集合"></a>整数集合</h3><h3 id="压缩列表"><a href="#压缩列表" class="headerlink" title="压缩列表"></a>压缩列表</h3><h3 id="对象-redis五大基本对象：字符串对象，列表对象，哈希对象，集合对象，有序集合对象"><a href="#对象-redis五大基本对象：字符串对象，列表对象，哈希对象，集合对象，有序集合对象" class="headerlink" title="对象-(redis五大基本对象：字符串对象，列表对象，哈希对象，集合对象，有序集合对象)"></a>对象-(redis五大基本对象：字符串对象，列表对象，哈希对象，集合对象，有序集合对象)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Typedef struct redisObject&#123; </div><div class="line">Unsigned type:<span class="number">4</span>;类型 </div><div class="line">Undigned encoding:<span class="number">4</span>;编码 </div><div class="line">Void *ptr;指向底层实现数据结构的指针 </div><div class="line">… </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="字符串对象"><a href="#字符串对象" class="headerlink" title="字符串对象"></a>字符串对象</h3><blockquote>
<p>编码有三种：int，raw，embatr</p>
</blockquote>
<ol>
<li>当字符串对象存的时整数值，编码为int</li>
<li>当字符串对象存的是长度大于32 的字符串时，编码为raw</li>
<li>当字符串对象存的是小于等于32 的字符串时，编码为embstr</li>
</ol>
<ul>
<li>embstr编码时专门用来保存短字符串的一种优化编码方式，raw会调用两次内存分配函数来分别创建redisObject和sdshdr，而embstr只会调用一次内存分配函数分配一块连续的空间供redisObject和sdshdr使用，降低了内存分配和释放次数，同时所有数据保存在连续的内存中，能更好的利用缓存带来的优势） </li>
</ul>
<h3 id="列表对象"><a href="#列表对象" class="headerlink" title="列表对象"></a>列表对象</h3><blockquote>
<p>编码有两种：ziplist（压缩列表实现底层），linkedlist（双向列表实现底层） </p>
</blockquote>
<ul>
<li>当列表对象保存的所有字符串元素的长度都小于64字节并且元素数量小于512个时，使用ziplist编码，否则使用linkedlist编码 </li>
</ul>
<h3 id="哈希对象"><a href="#哈希对象" class="headerlink" title="哈希对象"></a>哈希对象</h3><blockquote>
<p>编码有两种：ziplist，hashtable（字典实现底层） </p>
</blockquote>
<ul>
<li>当列表对象保存的所有键值对的键和值的长度都小于64字节并且键值对数量小于512个时，使用ziplist编码（使用ziplist编码时，键值两个节点始终相邻，键节点在前，值节点在后）否则使用linkedlist编码 </li>
</ul>
<h3 id="集合对象"><a href="#集合对象" class="headerlink" title="集合对象"></a>集合对象</h3><blockquote>
<p>编码有两种：intset（整数集合实现底层），hashtable </p>
</blockquote>
<ul>
<li>使用hashtable编码时，字典的每个键都是一个包含集合元素的字符串对象，而字典的值全都置为null </li>
<li>当集合对象保存的所有对象均为整数时且集合中元素数量不超过512个时使用intset编码，否则使用hashtable编码 </li>
</ul>
<h3 id="有序集合对象"><a href="#有序集合对象" class="headerlink" title="有序集合对象"></a>有序集合对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Typedef struct zset&#123; </div><div class="line">Skiplist *zsl;跳跃链表 </div><div class="line">Dict *dict;字典 </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>编码有两种：ziplist，skiplist（zset结构实现底层） </p>
</blockquote>
<ul>
<li>使用ziplist编码时，每个集合元素使用两个紧邻的压缩列表节点来保存，第一个保存元素成员，第二个保存元素的分值 </li>
<li>Zset结构同时使用跳跃链表（有序排列集合元素，可实现范围型操作）和字典（O(1)复杂度查找集合元素值） </li>
<li>当集合每个元素的长度都小于64字节并且元素数量小于128个时，使用ziplist编码，否则使用skiplist编码 </li>
</ul>
<h2 id="内存回收机制"><a href="#内存回收机制" class="headerlink" title="内存回收机制"></a>内存回收机制</h2><p>引用计数技术 </p>
<h2 id="对象共享"><a href="#对象共享" class="headerlink" title="对象共享"></a>对象共享</h2><blockquote>
<p>对象的空转时长（当前时间-lru） </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Typedef struct redisObject&#123; </div><div class="line">… </div><div class="line">Undigned lru:<span class="number">22</span>;记录对象最后一次被命令程序访问的时间 </div><div class="line">… </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>当服务器的内存占用数超过maxmemory时，空转时长较高的会优先被服务器释放 </li>
</ul>
<h2 id="单机数据库"><a href="#单机数据库" class="headerlink" title="单机数据库"></a>单机数据库</h2><ul>
<li>Redis客户端默认目标数据库为0号数据库，可以使用SELECT命令来切换目标数据库 </li>
<li>Set data “2013.12.03” 添加信息 </li>
<li>Del data 删除信息 </li>
<li>Set massage “hello” (将massage的值改为hello)或者 hset book page 80（将book中的page改为80）修改信息 </li>
<li>Get message 查找信息 </li>
<li>Expire/pexpire key 5 设置键的生存时间/过期时间 <ol>
<li>过期键的删除策略 </li>
<li>定时删除：定时器 </li>
<li>惰性删除：放任不管，只有当每次取键时检查是否过期，是删除，否返回 </li>
<li>定期删除 </li>
</ol>
</li>
</ul>
<h2 id="RDB持久化（通过保存数据库中的键值对来记录数据库的不同状态）"><a href="#RDB持久化（通过保存数据库中的键值对来记录数据库的不同状态）" class="headerlink" title="RDB持久化（通过保存数据库中的键值对来记录数据库的不同状态）"></a>RDB持久化（通过保存数据库中的键值对来记录数据库的不同状态）</h2><blockquote>
<ul>
<li>手动或定期 </li>
<li>.rdb 文件 压缩的二进制文件 </li>
</ul>
</blockquote>
<ul>
<li>Rdb文件的创建与载入 <ol>
<li>Save命令会阻塞redis服务器进程，直到rdb文件创建完成，期间服务器不能处理任何请求 </li>
<li>Bgsave命令会派生出一个子进程执行创建rdb文件，父进程继续执行请求处理 </li>
<li>Bgsave命令阶段，save，bgsave，bgrewriteaof这三种命令不能执行，其他请求可以执行 </li>
<li>默认条件为（当满足条件就执行bgsave命令） <ol>
<li>Save 900 1 服务器在900秒之内至少对数据库修改1次 </li>
<li>Save 300 10服务器在300秒之内至少对数据库修改10次 </li>
<li>Save 60 10000服务器在60秒之内至少对数据库修改10000次 </li>
</ol>
</li>
<li>Dirty计数器：记录上一次成功执行save/bgsave命令之后服务器对数据库的修改次数 </li>
<li>Lastsave：时间戳，记录上一次成功执行/bgsave命令的时间 </li>
<li>serverCron函数每隔100毫秒就执行一次，其中一项就是检查save/bgsave条件是否满足 </li>
</ol>
</li>
</ul>
<h2 id="AOF持久化（通过保存服务器执行的写命令来记录数据库的状态）"><a href="#AOF持久化（通过保存服务器执行的写命令来记录数据库的状态）" class="headerlink" title="AOF持久化（通过保存服务器执行的写命令来记录数据库的状态）"></a>AOF持久化（通过保存服务器执行的写命令来记录数据库的状态）</h2><blockquote>
<p>三步走：命令追加-&gt;文件写入-&gt;文件同步 </p>
</blockquote>
<ul>
<li>每次执行完相应的命令会将命令以一定格式追加到aot_buf缓冲区的末尾 </li>
<li>Redis服务器进程就是一个事件循环，每结束一个循环都会调用相应的函数考虑是否将aot_buf缓冲区的内容写入AOF文件，上次同步时间距离现在超过一秒就再次执行同步 </li>
<li>Aof文件重写，随着时间的推移，aof文件的大小会迅速增加，其中会包括很多的冗余命令，所以需要重写来减小文件大小 </li>
<li>原理：从数据库读取当前的键值，然后用命令来记录键值对，替换之前冗余的命令 </li>
<li>子进程执行该过程，不会影响服务器的请求处理 </li>
<li>Aof执行期间，服务器依旧会将执行过的写命令追加到aof缓冲区，同时还会将执行过的写命令追加到aof重写缓冲区 </li>
</ul>
<h2 id="事件：redis服务器就是一个事件驱动程序"><a href="#事件：redis服务器就是一个事件驱动程序" class="headerlink" title="事件：redis服务器就是一个事件驱动程序"></a>事件：redis服务器就是一个事件驱动程序</h2><ul>
<li>文件事件：redis通过套接字与客户端进行链接，文件事件就是服务器对套接字操作的抽象，服务器和客户端的通信会产生相应的文件事件，而服务器通过监听并处理这些事件来完成网络通信操作（读事件，写事件两类） </li>
<li>套接字（准备好链接应答，写入，读取，关闭等操作时）-&gt;I/O多路复用（将套接字以队列的形式往后传递）-&gt;文件事件派发器（根据套接字产生的事件类型调用相应的事件处理器执行）-&gt;事件处理器（命令请求处理器…） </li>
<li>时间事件：服务器对定时操作的抽象 </li>
<li>定时事件，周期事件 </li>
<li>所有时间事件存放在一个无序链表（不按照when属性排列）中，每当时间事件执行时都必须遍历整个链表来找到已到达时间事件（新事件的插入总是插入到表头） </li>
<li>两事件均同步，有序，原子执行，不会出现中断，抢占现象，需要时会主动让出执行权。 </li>
</ul>
<h2 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h2><blockquote>
<p>（slaveof命令）从服务器&gt; slaveof 主服务器 </p>
</blockquote>
<ul>
<li>旧版复制=同步+命令传播 </li>
<li><p>同步： </p>
<ol>
<li>从向主发送sync命令 </li>
<li>主收到sync命令后执行bgsave命令，后台生成一个rdb文件，并使用缓冲区记录从现在开始的所有写命令 </li>
<li>主将rdb文件发给从服务器，从服务器接受并载入rdb文件，根据此文件将自己的数据库状态更新至主服务器状态 </li>
<li>主将缓冲区内容发给从，从执行缓冲区命令更新自己 </li>
</ol>
</li>
<li><p>命令传播：当同步执行完成之后，主服务器只需要一直保持将自己的写命令发给从服务器，从服务器接受并更新即可保持主从一直 </p>
</li>
</ul>
<blockquote>
<p>复制分两种情况，初次复制，断线后重复制（低效，因为不能实现从断线处继续复制，而是重新复制），新版将同步分为完整同步和部分同步来优化断线后重新复制 </p>
</blockquote>
<h2 id="redis集群"><a href="#redis集群" class="headerlink" title="redis集群"></a>redis集群</h2><ul>
<li>节点连接命令：cluster meet <ip> <port> </port></ip></li>
<li>Cluster-enabled=yes开启服务器的集群模式 </li>
<li>槽指派：redis集群通过分片方式来保存数据库中的键值对，整个数据库被分为16384个槽位，数据库中每一个键都属于槽的其中一个，每个节点可以处理0个或者16384个，当所有槽位均有节点在处理时，集群属于上线状态，否则属于下线状态 </li>
<li>命令cluster addslots <slot> [slot…]将一个或者多个槽位指派给节点负责 </slot></li>
<li>16384/8个字节，包含16384个二进制位来保存节点负责的槽位信息，为1，表示该节点负责处理该槽位，否则不负责处理 </li>
</ul>
<p>重新分片<br>发布订阅<br>Dict&lt;被订阅频道，List&lt;订阅者链表&gt;&gt;<br>事物<br>multi命令开始，中间执行命令，exec命令结束提交事务<br>watch命令是一个乐观锁，在exec命令之前监视任意数量的数据库键是否至少有一个被修改过，是则拒绝事务<br>Lua脚本<br>排序<br>sort命令排序。。。 </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://lfstefan.github.io/2018/04/01/Java描绘数据统计图/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘飞">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="染心">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/04/01/Java描绘数据统计图/" itemprop="url">
                  Java描绘数据统计图
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-01T12:13:25+08:00">
                2018-04-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ECharts/" itemprop="url" rel="index">
                    <span itemprop="name">ECharts</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/01/Java描绘数据统计图/" class="leancloud_visitors" data-flag-title="Java描绘数据统计图">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h3 id="Java描绘数据统计图"><a href="#Java描绘数据统计图" class="headerlink" title="Java描绘数据统计图"></a>Java描绘数据统计图</h3><h4 id="ECharts"><a href="#ECharts" class="headerlink" title="ECharts"></a><a href="http://echarts.baidu.com/" title="echarts" target="_blank" rel="external">ECharts</a></h4><blockquote>
<h4 id="最近需要实现一个数据曲线对比的小任务，于是想试试描绘数据统计图，了解到可以使用echarts和hcharts，这里使用的是echarts，首先官方实例很好，容易理解且上手快，但是都是静态的，我要实现的是动态获取后台数据来前台显示数据曲线对比，所以会涉及到ajax和json的相关内容（读者自行了解）！"><a href="#最近需要实现一个数据曲线对比的小任务，于是想试试描绘数据统计图，了解到可以使用echarts和hcharts，这里使用的是echarts，首先官方实例很好，容易理解且上手快，但是都是静态的，我要实现的是动态获取后台数据来前台显示数据曲线对比，所以会涉及到ajax和json的相关内容（读者自行了解）！" class="headerlink" title="最近需要实现一个数据曲线对比的小任务，于是想试试描绘数据统计图，了解到可以使用echarts和hcharts，这里使用的是echarts，首先官方实例很好，容易理解且上手快，但是都是静态的，我要实现的是动态获取后台数据来前台显示数据曲线对比，所以会涉及到ajax和json的相关内容（读者自行了解）！"></a>最近需要实现一个数据曲线对比的小任务，于是想试试描绘数据统计图，了解到可以使用echarts和hcharts，这里使用的是echarts，首先官方实例很好，容易理解且上手快，但是都是静态的，我要实现的是动态获取后台数据来前台显示数据曲线对比，所以会涉及到ajax和json的相关内容（读者自行了解）！</h4></blockquote>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/04/01/Java描绘数据统计图/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://lfstefan.github.io/2017/11/18/LintCode_LongestConsecutiveSequence/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘飞">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="染心">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/18/LintCode_LongestConsecutiveSequence/" itemprop="url">
                  LintCode_Longest Consecutive Sequence
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-18T20:49:53+08:00">
                2017-11-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Algorithms/" itemprop="url" rel="index">
                    <span itemprop="name">Algorithms</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/11/18/LintCode_LongestConsecutiveSequence/" class="leancloud_visitors" data-flag-title="LintCode_Longest Consecutive Sequence">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><blockquote>
<p>Given an unsorted array of integers, find the length of the longest consecutive elements sequence.<br>Clarification：Your algorithm should run in O(n) complexity.</p>
</blockquote>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><blockquote>
<p>Given [100, 4, 200, 1, 3, 2],<br>The longest consecutive elements sequence is [1, 2, 3, 4]. Return its length: 4.</p>
</blockquote>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><blockquote>
<p>一开始想到的就是先排序，然后求最长连续序列，但是快排都需要nlogn的时间消耗，同时还需要去重操作，所以我想到的是用Map来存放数组元素，Map的key和value均为数组元素值，这样同时满足了排序和去重的需求，而且所耗时间为n（此处我忽略了map中key对负数的处理，导致我的代码只对数组中元素均为正数的情况有效），然后遍历map判定其下一个元素是否在map中存在，以此来找出最长连续序列，代码如下：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">longestConsecutive</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(nums.length==<span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span>(nums.length==<span class="number">1</span>)</div><div class="line">            <span class="keyword">return</span> nums[<span class="number">0</span>];</div><div class="line">        Map&lt;Integer,Integer&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</div><div class="line">            map.put(nums[i],nums[i]);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> maxLength = <span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> tempLength = <span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span>(Map.Entry&lt;Integer,Integer&gt; entry : map.entrySet())&#123;</div><div class="line">            <span class="keyword">if</span>(map.get(entry.getKey()+<span class="number">1</span>)!=<span class="keyword">null</span>)&#123;</div><div class="line">                tempLength++;</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                maxLength = maxLength &gt; tempLength ? maxLength : tempLength;</div><div class="line">                tempLength = <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> maxLength;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>改进：map改用set去重，然后遍历数组，然后利用set找出以该元素为中心的连续序列的上下限为多少（之前用map的好处是已经排好序，只需找出上限即可），实现代码如下：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> nums: A list of integers</div><div class="line">     * <span class="doctag">@return</span> an integer</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">longestConsecutive</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</div><div class="line">        HashSet&lt;Integer&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</div><div class="line">            set.add(nums[i]);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> longest = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</div><div class="line">            <span class="keyword">int</span> down = nums[i] - <span class="number">1</span>;</div><div class="line">            <span class="keyword">while</span> (set.contains(down)) &#123;</div><div class="line">                set.remove(down);</div><div class="line">                down--;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">int</span> up = nums[i] + <span class="number">1</span>;</div><div class="line">            <span class="keyword">while</span> (set.contains(up)) &#123;</div><div class="line">                set.remove(up);</div><div class="line">                up++;</div><div class="line">            &#125;</div><div class="line">            longest = Math.max(longest, up - down - <span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> longest;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="刘飞" />
          <p class="site-author-name" itemprop="name">刘飞</p>
           
              <p class="site-description motion-element" itemprop="description">一只奋进的小菜鸟</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">74</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">65</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/LFstefan" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  Sat Apr 29 2017 08:00:00 GMT+0800 (中国标准时间) - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘飞</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  
    

    
  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      $('#local-search-input').focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("4jo3lh32lhNprUWelt3fCUrM-gzGzoHsz", "cTko66LfK5xF0OrYbFlACBB7");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

</body>
</html>
