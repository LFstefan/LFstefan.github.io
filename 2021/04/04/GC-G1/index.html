<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|comic sans:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Java,GC," />





  <link rel="alternate" href="/atom.xml" title="染心" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="GC-G1  算法实现 优点缺点 参数配置 日志解释 调优策略">
<meta name="keywords" content="Java,GC">
<meta property="og:type" content="article">
<meta property="og:title" content="GC-G1">
<meta property="og:url" content="https://lfstefan.github.io/2021/04/04/GC-G1/index.html">
<meta property="og:site_name" content="染心">
<meta property="og:description" content="GC-G1  算法实现 优点缺点 参数配置 日志解释 调优策略">
<meta property="og:updated_time" content="2021-04-07T03:37:13.595Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GC-G1">
<meta name="twitter:description" content="GC-G1  算法实现 优点缺点 参数配置 日志解释 调优策略">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://lfstefan.github.io/2021/04/04/GC-G1/"/>





  <title>GC-G1 | 染心</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>
    <a href="https://github.com/LFstefan"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/567c3a48d796e2fc06ea80409cc9dd82bf714434/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">染心</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Coding Everyday</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://lfstefan.github.io/2021/04/04/GC-G1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘飞">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="染心">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                GC-G1
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-04T20:49:53+08:00">
                2021-04-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/GC/" itemprop="url" rel="index">
                    <span itemprop="name">GC</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2021/04/04/GC-G1/" class="leancloud_visitors" data-flag-title="GC-G1">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="GC-G1"><a href="#GC-G1" class="headerlink" title="GC-G1"></a>GC-G1</h1><blockquote>
<ul>
<li>算法实现</li>
<li>优点缺点</li>
<li>参数配置</li>
<li>日志解释</li>
<li>调优策略</li>
</ul>
</blockquote>
<a id="more"></a>
<blockquote>
<p>以下所有内容均基于java8而写，新版本java可能会有变动</p>
</blockquote>
<h2 id="算法实现"><a href="#算法实现" class="headerlink" title="算法实现"></a>算法实现</h2><ul>
<li>从逻辑上讲，G1是世代相传的。一组空区域被指定为逻辑年轻代。在图中，年轻一代是浅蓝色的。分配是从逻辑上年轻的一代中完成的，当年轻一代已满时，该区域集将被垃圾收集（一个年轻的集合）。在某些情况下，可以同时收集一组年轻区域之外的区域（深蓝色的旧区域）。这称为混合集合。在图中，正在收集的区域用红色框标记。该图说明了混合的集合，因为同时收集了年轻区域和旧区域。垃圾收集是一个压缩收集，它将活动对象复制到选定的最初为空的区域。根据幸存对象的年龄，可以将对象复制到幸存者区域（标有“ S”）或复制到旧区域（未具体显示）。标有“ H”的区域包含的绒毛物体大于一个区域的一半，并且经过特殊处理</li>
<li>分配（疏散）失败: 与CMS一样，当应用程序继续运行时，G1收集器将运行其部分收集，并且存在这样的风险，即应用程序分配对象的速度将超过垃圾收集器可以回收可用空间的速度。 在G1中，当G1将活动数据从一个区域复制（撤离）到另一个区域时，发生故障（Java堆耗尽）。 复制是为了压缩实时数据。 如果在撤离正在收集垃圾的区域时找不到空闲（空）区域，则会发生分配失败（因为没有空间可以从正在撤离的区域分配有生命的物体），并且会停止（ STW）已完成完整收集。</li>
<li>浮动垃圾: 对象可能在G1收集期间死亡，无法收集。 G1使用一种称为快照快照（SATB）的技术来确保垃圾收集器找到所有活动对象。 SATB指出，出于收集的目的，在并发标记（整个堆上的标记）开始时处于活动状态的任何对象都被视为处于活动状态。 SATB以类似于CMS增量更新的方式允许浮动垃圾。</li>
<li>暂停: G1暂停应用程序以将活动对象复制到新区域。这些暂停可以是仅收集年轻区域的年轻收集暂停，也可以是疏散年轻和旧区域的混合收集暂停。与CMS一样，在应用程序停止时，有最后的标记或remark暂停以完成标记。 CMS还具有初始标记暂停，而G1则作为疏散暂停的一部分进行初始标记工作。 G1在gc收集的结尾有一个清理阶段，该阶段部分是STW，部分是并发的。清理阶段的STW部分标识空区域，并确定旧区域作为下一个集合的候选对象。</li>
<li>卡表和并发阶段: 如果垃圾收集器没有收集整个堆（增量收集），则垃圾收集器需要知道从堆的未收集部分到正在收集的堆部分的指针在哪里。这通常用于分代垃圾收集器，其中堆的未收集部分通常是旧的一代，而堆的收集部分是年轻的一代。用于保存此信息的数据结构（指向年轻一代对象的老一代指针）是一个可记住的集合。卡表是一种特殊的记忆结构。 Java HotSpot VM使用字节数组作为卡表。每个字节称为卡。卡与堆中的地址范围相对应。弄脏卡意味着将字节的值更改为脏值。脏值可能会在卡所覆盖的地址范围内包含从旧一代到年轻一代的新指针。处理卡意味着查看卡，看是否有老一代指向年轻一代的指针，并可能对该信息进行某些处理，例如将其传输到另一个数据结构。<ul>
<li>G1具有并发标记阶段，该阶段标记从应用程序中找到的活动对象。并发标记从疏散暂停（完成初始标记工作）结束到标记为止。并发清理阶段将集合清空的区域添加到空闲区域列表中，并清除记住的那些区域集。此外，并发优化线程将根据需要运行，以处理已被应用程序写入弄脏并且可能具有跨区域引用的卡表条目。</li>
</ul>
</li>
<li>G1 GC是一个区域化的分代垃圾收集器，这意味着Java对象堆（堆）被划分为多个大小相等的区域。启动时，Java虚拟机（JVM）设置区域大小。区域大小可以从1 MB到32 MB不等，具体取决于堆大小。目标是不超过2048个区域。伊甸区，幸存者区和旧代区是这些地区的逻辑集合，并不连续。</li>
<li>G1 GC具有尝试达到的暂停时间目标（软实时）。在年轻系列中，G1 GC会调整其年轻一代（伊甸园和幸存者的大小），以达到柔和的实时目标。</li>
<li>在混合收集期间，G1 GC根据目标混合垃圾收集数量，堆中每个区域中的活动对象百分比以及总体可接受的堆废物百分比，来调整收集的旧区域的数量。</li>
<li>G1 GC通过将活动对象从一个或多个区域集（称为集合集（CSet））递增并行复制到一个或多个不同的新区域中来实现压缩，从而减少了堆碎片。目标是从包含最大可回收空间的那些区域开始，尽可能多地回收堆空间，同时尝试不超过暂停时间目标（首先是垃圾）。</li>
<li><p>G1 GC使用独立的记忆集（<strong>RSets</strong>）来跟踪区域中的引用。独立的RSets可以并行和独立地收集区域，因为只有区域的RSet必须被扫描以寻找对该区域的引用，而不是整个堆的引用。 G1 GC使用 <strong>写后屏障</strong> 来记录对堆的更改并更新RSets。</p>
</li>
<li><p>垃圾收集阶段: 除了组成暂停世界（STW）的年轻垃圾和混合垃圾收集的撤离暂停（请参阅垃圾优先垃圾收集器中的分配（撤离）失败部分）外，G1 GC还具有并行，并发和多阶段标记周期。 G1 GC使用 <strong>“开始时快照”（SATB）算法</strong>，该算法在标记周期开始时从逻辑上对堆中活动对象集进行快照。活动对象集还包括自标记周期开始以来分配的对象。 G1 GC标记算法使用预写屏障来记录和标记属于逻辑快照的对象。</p>
</li>
<li>年轻代垃圾收集: G1 GC满足了来自添加到eden区域集中的区域的大多数分配请求。在年轻的垃圾收集期间，G1 GC从先前的垃圾收集中收集了伊甸园地区和幸存者地区。来自伊甸园地区和幸存者地区的活物被复制或撤离到一组新的地区。特定对象的目标区域取决于对象的年龄。经过充分老化的物体已被疏散到较旧的区域（即被提升）；否则，该对象将撤离到幸存者区域，并将包含在下一个年轻垃圾或混合垃圾收集的CSet中。</li>
<li>混合垃圾收集: 成功完成并发标记周期后，G1 GC从执行年轻垃圾收集切换为执行混合垃圾收集。在混合垃圾收集中，G1 GC可以选择将一些旧区域添加到将要收集的伊甸园区域和幸存者区域中。所添加的旧区域的确切数量由多个标志控制。在G1 GC收集到足够数量的旧区域（通过多个混合垃圾收集）之后，G1恢复执行新的垃圾收集，直到下一个标记周期完成。</li>
</ul>
<h3 id="标记周期的各个阶段"><a href="#标记周期的各个阶段" class="headerlink" title="标记周期的各个阶段"></a>标记周期的各个阶段</h3><ul>
<li>初始标记阶段：G1 GC在此阶段标记根。此阶段由常规（STW）的年轻垃圾回收承载。</li>
<li>根区域扫描阶段：G1 GC扫描在初始标记阶段标记的幸存者区域，以参考旧一代并标记所参考的对象。该阶段与应用程序（不是STW）同时运行，并且必须在下一个STW年轻垃圾收集开始之前完成。</li>
<li>并发标记阶段：G1 GC在整个堆中找到可访问的（活动的）对象。此阶段与应用程序同时发生，并且可以被STW年轻的垃圾回收中断。</li>
<li>标记阶段：此阶段是STW收集，有助于完成标记周期。 G1 GC耗尽SATB缓冲区，跟踪未访问的活动对象，并执行参考处理。</li>
<li>清理阶段：在此最后阶段，G1 GC执行记帐和RSet清理的STW操作。在记帐期间，G1 GC会确定完全空闲的区域和混合垃圾收集候选对象。清除阶段在重置并将空闲区域返回到空闲列表时，部分处于并发状态。</li>
</ul>
<h2 id="优点缺点"><a href="#优点缺点" class="headerlink" title="优点缺点"></a>优点缺点</h2><ul>
<li><p>Garbage-First（G1）垃圾收集器是一种服务器样式的垃圾收集器，适用于具有大内存的多处理器计算机。它尝试以高概率满足垃圾收集（GC）暂停时间目标，同时实现高吞吐量。全堆操作（例如全局标记）与应用程序线程同时执行。这样可以防止与堆或活动数据大小成比例的中断。</p>
</li>
<li><p>G1收集器通过多种技术实现了高性能和暂停时间目标。</p>
<ul>
<li>堆被划分为一组大小相等的堆区域，每个堆区域都有一个连续的虚拟内存范围。 G1执行并发全局标记阶段，以确定整个堆中对象的活动性。标记阶段完成后，G1知道哪些区域大部分为空。它首先收集这些区域，这通常会产生大量的自由空间。这就是为什么这种垃圾收集方法称为“垃圾优先”的原因。顾名思义，G1将其收集和压缩活动集中在可能充满可回收对象（即垃圾）的堆区域中。 G1使用暂停预测模型来满足用户定义的暂停时间目标，并根据指定的暂停时间目标选择要收集的区域数。</li>
<li>G1将对象从堆的一个或多个区域复制到堆上的单个区域，并且在此过程中，压缩和释放了内存。该操作是在多处理器上并行执行的，以减少暂停时间并增加吞吐量。因此，对于每个垃圾回收，G1都会不断减少碎片。这超出了先前两种方法的能力。 CMS（并发标记扫描）垃圾收集不会进行压缩。并行压缩仅执行整个堆压缩，这会导致相当长的暂停时间。</li>
<li>重要的是要注意，G1不是实时收集器。它很有可能达到设定的暂停时间目标，但不是绝对确定的。根据先前收集的数据，G1估计在目标时间内可以收集多少个区域。因此，收集器具有收集区域成本的合理准确的模型，并且收集器使用此模型来确定要收集哪些区域和多少区域，同时保持在暂停时间目标之内。</li>
</ul>
</li>
<li><p>G1的首要重点是为运行需要大型堆且GC延迟有限的应用程序的用户提供解决方案。这意味着堆大小约为6 GB或更大，并且稳定且可预测的暂停时间低于0.5秒。</p>
<ul>
<li>如果应用程序具有以下一个或多个特征，那么今天运行CMS或并行压缩的应用程序将从切换到G1中受益。</li>
<li>超过50％的Java堆被实时数据占用。</li>
<li>对象分配率或提升率差异很大。</li>
<li>该应用程序正在经历不希望的长时间垃圾收集或压缩暂停（长于0.5到1秒）。</li>
</ul>
</li>
<li><p>计划将G1作为并发标记扫描收集器（CMS）的长期替代产品。将G1与CMS进行比较，可以发现使G1成为更好解决方案的差异。一个区别是G1是压紧收集器。此外，G1提供的垃圾收集暂停比CMS收集器更具可预测性，并允许用户指定所需的暂停目标。</p>
</li>
<li><p>与CMS一样，G1专为需要更短GC暂停的应用而设计。</p>
</li>
<li><p>开始并发收集周期: 如前所述，无论是旧区还是旧区，都是混合收集的垃圾。为了收集旧区域，G1对堆中的活动对象进行了完整的标记。这样的标记是通过并发标记阶段完成的。当整个Java堆的占用达到参数InitiatingHeapOccupancyPercent的值时，将开始并发标记阶段。使用命令行选项-XX：InitiatingHeapOccupancyPercent = <nn>设置此参数的值。 InitiatingHeapOccupancyPercent的默认值为45。</nn></p>
</li>
<li>暂停时间目标: 使用标志MaxGCPauseMillis为G1设置一个暂停时间目标。 G1使用预测模型来确定在该目标暂停时间内可以完成多少垃圾收集工作。在收集结束时，G1选择要在下一个收集（收集集）中收集的区域。集合集将包含年轻区域（其大小的总和决定逻辑年轻代的大小）。 G1部分地通过选择集合集中的年轻区域的数量来控制GC暂停的长度。您可以像其他垃圾收集器一样在命令行上指定年轻代的大小，但是这样做可能会妨碍G1达到目标暂停时间的能力。除了暂停时间目标之外，您还可以指定可能发生暂停的时间段的长度。您可以在此时间跨度（GCPauseIntervalMillis）中指定最小的转换器使用量以及暂停时间目标。 MaxGCPauseMillis的默认值为200毫秒。 GCPauseIntervalMillis（0）的默认值等效于时间跨度上的任何要求。</li>
</ul>
<h3 id="大对象分配"><a href="#大对象分配" class="headerlink" title="大对象分配"></a>大对象分配</h3><ul>
<li>对于G1 GC，任何大于区域大小一半的对象都被认为是巨大的对象。这样的对象在老一代中直接分配到庞大的区域中。这些巨大的区域是一组连续的区域。 StartsHumongous标志着连续集合的开始，ContinuesHumongous标志着集合的继续。</li>
<li>在分配任何大型区域之前，将检查标记阈值，并在必要时启动并发循环。</li>
<li>在清理阶段以及整个垃圾收集周期的标记周期结束时，将释放死掉的巨型对象。</li>
<li>为了减少复制开销，巨大的对象不包括在任何撤离暂停中。完整的垃圾收集周期将庞大的对象压缩到位。</li>
<li>因为每个单独的StartsHumongous和ContinuesHumongous区域集仅包含一个humongous对象，所以未使用humongous对象的末尾与该对象所覆盖的最后一个区域的末尾之间的空间。对于刚好大于堆区域大小倍数的对象，未使用的空间可能导致堆碎片化。</li>
<li>如果您看到由于庞大的分配而启动的背对背并发周期，并且如果此类分配使您的上一代分裂了，请增加-XX：G1HeapRegionSize的值，以使先前的庞大对象不再是庞大的对象，并且将遵循常规分配路径。</li>
</ul>
<h2 id="参数配置"><a href="#参数配置" class="headerlink" title="参数配置"></a>参数配置</h2><blockquote>
<p>G1 GC是具有默认设置的自适应垃圾收集器，可使其无需修改即可高效工作</p>
</blockquote>
<ul>
<li>-XX:G1HeapRegionSize=n : 设置G1区域的大小。 该值为2的幂，范围为1 MB到32 MB。 目标是根据最小Java堆大小具有大约2048个区域。</li>
<li>-XX:MaxGCPauseMillis=200 : 为所需的最大暂停时间设置目标值。 默认值为200毫秒。 指定的值不适合您的堆大小。</li>
<li>-XX:G1NewSizePercent=5 : 设置要用作年轻代大小的最小值的堆百分比。 默认值为Java堆的5％。这是一个实验性标志。 有关示例，请参见如何解锁实验性VM标志。 此设置替换-XX：DefaultMinNewGenPercent设置。</li>
<li>-XX:G1MaxNewSizePercent=60 : 设置堆大小的百分比，以用作年轻代大小的最大值。 默认值为Java堆的60％。这是一个实验性标志。 有关示例，请参见如何解锁实验性VM标志。 此设置替换-XX：DefaultMaxNewGenPercent设置。</li>
<li>-XX:ParallelGCThreads=n : 设置STW工作线程的值。 将n的值设置为逻辑处理器的数量。 n的值与最多等于8的逻辑处理器的数量相同。如果逻辑处理器多于八个，则将n的值设置为逻辑处理器的大约5/8。 除较大的SPARC系统外，这在大多数情况下均有效，其中n的值约为逻辑处理器的5/16。</li>
<li>-XX:ConcGCThreads=n : 设置并发标记线程的数量。 将n设置为并行垃圾回收线程数（ParallelGCThreads）的大约1/4。</li>
<li>-XX:InitiatingHeapOccupancyPercent=45 : 设置触发标记周期的Java堆占用阈值。 默认占用率为整个Java堆的45％。</li>
<li>-XX:G1MixedGCLiveThresholdPercent=85 : 设置要包含在混合垃圾收集周期中的旧区域的占用阈值。 默认占用率为85％。这是一个实验性标志。 有关示例，请参见如何解锁实验性VM标志。 此设置替换-XX：G1OldCSetRegionLiveThresholdPercent设置。</li>
<li>-XX:G1HeapWastePercent=5 : 设置您愿意浪费的堆百分比。 当可回收百分比小于堆垃圾百分比时，Java HotSpot VM不会启动混合垃圾回收周期。 默认值为5％。</li>
<li>-XX:G1MixedGCCountTarget=8 : 设置标记周期后混合垃圾回收的目标数量，以收集具有最多G1MixedGCLIveThresholdPercent个实时数据的旧区域。 默认值为8个混合垃圾回收。 混合馆藏的目标是在此目标数量之内。</li>
<li>-XX:G1OldCSetRegionThresholdPercent=10 : 设置在混合垃圾收集周期中要收集的旧区域数的上限。 默认值为Java堆的10％。</li>
<li>-XX:G1ReservePercent=10 : 设置保留内存的百分比以使其保持空闲状态，以减少空间溢出的风险。 默认值为10％。 当您增加或减少百分比时，请确保将总Java堆调整相同的数量。</li>
</ul>
<blockquote>
<p>如何解锁实验性VM标志: 要更改实验性标志的值，您必须先将其解锁。您可以通过在任何实验性标志之前在命令行上显式设置-XX：+ UnlockExperimentalVMOptions来执行此操作</p>
</blockquote>
<h3 id="参数配置样例"><a href="#参数配置样例" class="headerlink" title="参数配置样例"></a>参数配置样例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-XX:+UseG1GC</div></pre></td></tr></table></figure>
<h2 id="日志解释"><a href="#日志解释" class="headerlink" title="日志解释"></a>日志解释</h2><ul>
<li>Young GC：所有Eden区域满了后触发，并行收集，且完全STW。</li>
<li>并发标记周期：它的第一个阶段初始化标记和YGC一起发生，这个周期的目的就是找到回收价值最大的Region集合（垃圾很多，存活对象很少），为接下来的Mixed GC服务。</li>
<li>Mixed GC：回收所有年轻代的Region和部分老年代的Region</li>
<li>Full GC：非常慢，STW且回收所有类型的Region。</li>
</ul>
<h3 id="日志样例"><a href="#日志样例" class="headerlink" title="日志样例"></a>日志样例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">// YGC log</div><div class="line">3.378: [GC pause (G1 Evacuation Pause) (young), 0.0015185 secs]</div><div class="line">   [Parallel Time: 0.7 ms, GC Workers: 4]</div><div class="line">      [GC Worker Start (ms): Min: 3378.1, Avg: 3378.3, Max: 3378.6, Diff: 0.5]</div><div class="line">      [Ext Root Scanning (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 0.6]</div><div class="line">      [Update RS (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</div><div class="line">         [Processed Buffers: Min: 0, Avg: 0.2, Max: 1, Diff: 1, Sum: 1]</div><div class="line">      [Scan RS (ms): Min: 0.0, Avg: 0.1, Max: 0.1, Diff: 0.1, Sum: 0.3]</div><div class="line">      [Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]</div><div class="line">      [Object Copy (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</div><div class="line">      [Termination (ms): Min: 0.0, Avg: 0.2, Max: 0.3, Diff: 0.3, Sum: 0.7]</div><div class="line">         [Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 4]</div><div class="line">      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]</div><div class="line">      [GC Worker Total (ms): Min: 0.1, Avg: 0.4, Max: 0.6, Diff: 0.6, Sum: 1.8]</div><div class="line">      [GC Worker End (ms): Min: 3378.7, Avg: 3378.7, Max: 3378.8, Diff: 0.1]</div><div class="line">   [Code Root Fixup: 0.0 ms]</div><div class="line">   [Code Root Purge: 0.0 ms]</div><div class="line">   [Clear CT: 0.1 ms]</div><div class="line">   [Other: 0.7 ms]</div><div class="line">      [Choose CSet: 0.0 ms]</div><div class="line">      [Ref Proc: 0.5 ms]</div><div class="line">      [Ref Enq: 0.0 ms]</div><div class="line">      [Redirty Cards: 0.1 ms]</div><div class="line">      [Humongous Register: 0.0 ms]</div><div class="line">      [Humongous Reclaim: 0.1 ms]</div><div class="line">      [Free CSet: 0.1 ms]</div><div class="line">   [Eden: 304.0M(304.0M)-&gt;0.0B(304.0M) Survivors: 2048.0K-&gt;2048.0K Heap: 304.5M(512.0M)-&gt;529.0K(512.0M)]</div><div class="line"> [Times: user=0.01 sys=0.00, real=0.00 secs] </div><div class="line"> // 抽象后为</div><div class="line"> GC pause (G1 Evacuation Pause) (young)</div><div class="line">  ├── Parallel Time</div><div class="line">    ├── GC Worker Start</div><div class="line">    ├── Ext Root Scanning</div><div class="line">    ├── Update RS</div><div class="line">    ├── Scan RS</div><div class="line">    ├── Code Root Scanning</div><div class="line">    ├── Object Copy</div><div class="line">  ├── Code Root Fixup</div><div class="line">  ├── Code Root Purge</div><div class="line">  ├── Clear CT</div><div class="line">  ├── Other</div><div class="line">    ├── Choose CSet</div><div class="line">    ├── Ref Proc</div><div class="line">    ├── Ref Enq</div><div class="line">    ├── Redirty Cards</div><div class="line">    ├── Humongous Register</div><div class="line">    ├── Humongous Reclaim</div><div class="line">    ├── Free CSet   </div><div class="line"></div><div class="line">// 并发标记周期</div><div class="line"># 这一行日志是全局并发标记的第一个阶段，即初始化标记，是伴随YGC一起发生的，后面的857M-&gt;617M表示YGC发生前后堆内存变化，0.0112237表示YGC的耗时</div><div class="line">[GC pause (G1 Evacuation Pause) (young) (initial-mark) 857M-&gt;617M(1024M), 0.0112237 secs]</div><div class="line"># 开始并发ROOT区域扫描</div><div class="line">[GC concurrent-root-region-scan-start]</div><div class="line"># 结束并发ROOT区域扫描，并统计这个阶段的耗时</div><div class="line">[GC concurrent-root-region-scan-end, 0.0000525 secs]</div><div class="line">[GC concurrent-mark-start]</div><div class="line">[GC concurrent-mark-end, 0.0083864 secs]</div><div class="line"># 最终标记阶段完成并发标记阶段后遗留的工作，即SATB buffer处理，并统计这个阶段耗时</div><div class="line">[GC remark, 0.0038066 secs]</div><div class="line"># 清理阶段会根据所有Region标记信息，计算出每个Region存活对象信息，并且把Region根据GC回收效率排序</div><div class="line">[GC cleanup 680M-&gt;680M(1024M), 0.0006165 secs]</div><div class="line"></div><div class="line">// Mixed gc</div><div class="line">29.268: [GC pause (G1 Evacuation Pause) (mixed), 0.0059011 secs]</div><div class="line">   [Parallel Time: 5.6 ms, GC Workers: 4]</div><div class="line">      ... ...</div><div class="line">   [Code Root Fixup: 0.0 ms]</div><div class="line">   [Code Root Purge: 0.0 ms]</div><div class="line">   [Clear CT: 0.1 ms]</div><div class="line">   [Other: 0.3 ms]</div><div class="line">      ... ...</div><div class="line">   [Eden: 14.0M(14.0M)-&gt;0.0B(156.0M) Survivors: 10.0M-&gt;4096.0K Heap: 165.9M(512.0M)-&gt;148.7M(512.0M)]</div><div class="line"> [Times: user=0.02 sys=0.01, real=0.00 secs] </div><div class="line"></div><div class="line"> // Full gc</div><div class="line"> // 手动显示gc导致的（手动调用System.gc()）</div><div class="line"> 4.358: [Full GC (System.gc())  298M-&gt;509K(512M), 0.0101774 secs]</div><div class="line">   [Eden: 122.0M(154.0M)-&gt;0.0B(230.0M) Survivors: 4096.0K-&gt;0.0B Heap: 298.8M(512.0M)-&gt;509.4K(512.0M)], [Metaspace: 3308K-&gt;3308K(1056768K)]</div><div class="line"> [Times: user=0.01 sys=0.00, real=0.01 secs] </div><div class="line"> // 堆空间满导致的full gc</div><div class="line"> 805.815: [GC pause (G1 Evacuation Pause) (young) 96G-&gt;74G(100G), 2.4778659 secs] 813.964: [GC pause (G1 Evacuation Pause) (mixed)-- 97G-&gt;99G(100G), 23.7970094 secs] </div><div class="line">837.762: [GC pause (G1 Evacuation Pause) (mixed)-- 99G-&gt;99G(100G), 32.0781615 secs] </div><div class="line">869.842: [Full GC (Allocation Failure) 99G-&gt;62G(100G), 169.3897706 secs]</div></pre></td></tr></table></figure>
<h3 id="日志内容解释"><a href="#日志内容解释" class="headerlink" title="日志内容解释"></a>日志内容解释</h3><h3 id="内存溢出和耗尽日志消息"><a href="#内存溢出和耗尽日志消息" class="headerlink" title="内存溢出和耗尽日志消息"></a>内存溢出和耗尽日志消息</h3><ul>
<li><p>当在日志中看到“空间溢出（to-space overflow）”或“空间耗尽（ to-space exhausted）”消息时，G1 GC没有足够的内存来存储幸存者或升级对象，或两者都没有。 此时Java堆处于最大状态。消息示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">924.897: [GC pause (G1 Evacuation Pause) (mixed) (to-space exhausted), 0.1957310 secs]</div><div class="line">924.897: [GC pause (G1 Evacuation Pause) (mixed) (to-space overflow), 0.1957310 secs]</div></pre></td></tr></table></figure>
</li>
<li><p>解决方案</p>
<ul>
<li>增加-XX：G1ReservePercent选项的值（并相应增加总堆），以增加“至空间”的保留内存量。</li>
<li>通过减小-XX：InitiatingHeapOccupancyPercent的值来更早地开始标记周期。</li>
<li>增加-XX：ConcGCThreads选项的值，以增加并行标记线程的数量。</li>
</ul>
</li>
</ul>
<h2 id="调优策略"><a href="#调优策略" class="headerlink" title="调优策略"></a>调优策略</h2><h3 id="牢记以下建议"><a href="#牢记以下建议" class="headerlink" title="牢记以下建议"></a>牢记以下建议</h3><ul>
<li>年轻代大小：避免使用-Xmn选项或任何其他相关选项（例如-XX：NewRatio）来显式设置年轻代大小。固定年轻代的大小会覆盖目标暂停时间目标。</li>
<li>暂停时间目标：当您评估或调整任何垃圾收集时，总会有延迟与吞吐量之间的权衡。 G1 GC是具有统一暂停的增量垃圾收集器，但在应用程序线程上也有更多开销。 G1 GC的吞吐量目标是90％的应用时间和10％的垃圾收集时间。与Java HotSpot VM并行收集器进行比较。并行收集器的吞吐量目标是99％的应用程序时间和1％的垃圾收集时间。因此，在评估G1 GC的吞吐量时，请放宽暂停时间目标。设置过于激进的目标表示您愿意承担垃圾收集开销的增加，这直接影响了吞吐量。在评估G1 GC的延迟时，您可以设置所需的（软）实时目标，G1 GC会尝试达到此目标。副作用是，吞吐量可能会受到影响。</li>
<li>混合垃圾收集：调整混合垃圾收集时，请尝试以下选项<ul>
<li>-XX：InitiatingHeapOccupancyPercent：用于更改标记阈值。</li>
<li>-XX：G1MixedGCLiveThresholdPercent和-XX：G1HeapWastePercent：用于更改混合垃圾回收决策。</li>
<li>-XX：G1MixedGCCountTarget和-XX：G1OldCSetRegionThresholdPercent：用于调整旧区域的CSet。</li>
</ul>
</li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="http://op7sipvie.bkt.clouddn.com/wechat-reward-image.JPG" alt="刘飞 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="http://op7sipvie.bkt.clouddn.com/alipay-reward-image.JPG" alt="刘飞 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
            <a href="/tags/GC/" rel="tag"># GC</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/04/04/GC-ParallelGC/" rel="next" title="GC-ParallelGC">
                <i class="fa fa-chevron-left"></i> GC-ParallelGC
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/05/16/数据库连接池/" rel="prev" title="数据库连接池">
                数据库连接池 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="uyan_frame"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="刘飞" />
          <p class="site-author-name" itemprop="name">刘飞</p>
           
              <p class="site-description motion-element" itemprop="description">一只奋进的小菜鸟</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">158</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">60</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">148</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/LFstefan" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#GC-G1"><span class="nav-number">1.</span> <span class="nav-text">GC-G1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#算法实现"><span class="nav-number">1.1.</span> <span class="nav-text">算法实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#标记周期的各个阶段"><span class="nav-number">1.1.1.</span> <span class="nav-text">标记周期的各个阶段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优点缺点"><span class="nav-number">1.2.</span> <span class="nav-text">优点缺点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#大对象分配"><span class="nav-number">1.2.1.</span> <span class="nav-text">大对象分配</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参数配置"><span class="nav-number">1.3.</span> <span class="nav-text">参数配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#参数配置样例"><span class="nav-number">1.3.1.</span> <span class="nav-text">参数配置样例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志解释"><span class="nav-number">1.4.</span> <span class="nav-text">日志解释</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#日志样例"><span class="nav-number">1.4.1.</span> <span class="nav-text">日志样例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志内容解释"><span class="nav-number">1.4.2.</span> <span class="nav-text">日志内容解释</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存溢出和耗尽日志消息"><span class="nav-number">1.4.3.</span> <span class="nav-text">内存溢出和耗尽日志消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调优策略"><span class="nav-number">1.5.</span> <span class="nav-text">调优策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#牢记以下建议"><span class="nav-number">1.5.1.</span> <span class="nav-text">牢记以下建议</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  Sat Apr 29 2017 08:00:00 GMT+0800 (China Standard Time) - 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘飞</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  
    

    
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=https://lfstefan.github.io/"></script>
      <!-- UY END -->
    
  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      $('#local-search-input').focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("4jo3lh32lhNprUWelt3fCUrM-gzGzoHsz", "cTko66LfK5xF0OrYbFlACBB7");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

</body>
</html>
