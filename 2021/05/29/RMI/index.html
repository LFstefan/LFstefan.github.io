<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|comic sans:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="JAVA,RMI," />





  <link rel="alternate" href="/atom.xml" title="染心" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="RMI 使用样例 实现原理 源码解析 分布式垃圾回收-DGC 类比其他语言 c++ php golang   扩展 duboo的服务端多个tcp长链接复用如何实现 远程调用是否可以实现调用接口缓存（幂等/非幂等）">
<meta name="keywords" content="JAVA,RMI">
<meta property="og:type" content="article">
<meta property="og:title" content="RMI">
<meta property="og:url" content="https://lfstefan.github.io/2021/05/29/RMI/index.html">
<meta property="og:site_name" content="染心">
<meta property="og:description" content="RMI 使用样例 实现原理 源码解析 分布式垃圾回收-DGC 类比其他语言 c++ php golang   扩展 duboo的服务端多个tcp长链接复用如何实现 远程调用是否可以实现调用接口缓存（幂等/非幂等）">
<meta property="og:updated_time" content="2021-06-01T07:19:47.560Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RMI">
<meta name="twitter:description" content="RMI 使用样例 实现原理 源码解析 分布式垃圾回收-DGC 类比其他语言 c++ php golang   扩展 duboo的服务端多个tcp长链接复用如何实现 远程调用是否可以实现调用接口缓存（幂等/非幂等）">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://lfstefan.github.io/2021/05/29/RMI/"/>





  <title>RMI | 染心</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>
    <a href="https://github.com/LFstefan"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/567c3a48d796e2fc06ea80409cc9dd82bf714434/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">染心</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Coding Everyday</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://lfstefan.github.io/2021/05/29/RMI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘飞">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="染心">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                RMI
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-29T20:49:53+08:00">
                2021-05-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2021/05/29/RMI/" class="leancloud_visitors" data-flag-title="RMI">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h1><ul>
<li>使用样例</li>
<li>实现原理</li>
<li>源码解析</li>
<li>分布式垃圾回收-DGC</li>
<li>类比其他语言<ul>
<li>c++</li>
<li>php</li>
<li>golang</li>
</ul>
</li>
<li>扩展<ul>
<li>duboo的服务端多个tcp长链接复用如何实现</li>
<li>远程调用是否可以实现调用接口缓存（幂等/非幂等）</li>
</ul>
</li>
</ul>
<a id="more"></a>
<h2 id="使用样例"><a href="#使用样例" class="headerlink" title="使用样例"></a>使用样例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">// 定义远程调用接口，服务端负责编写需要暴露给客户端的远程调用接口，写好后打包提供给客户端使用</div><div class="line">import java.rmi.Remote; </div><div class="line">import java.rmi.RemoteException;  </div><div class="line">// Creating Remote interface for our application </div><div class="line">public interface Hello extends Remote &#123;  </div><div class="line">   void printMsg() throws RemoteException;  </div><div class="line">&#125; </div><div class="line">// 服务端实现暴露接口，赋予具体实现逻辑</div><div class="line">// Implementing the remote interface </div><div class="line">public class ImplExample implements Hello &#123;  </div><div class="line">   // Implementing the interface method </div><div class="line">   public void printMsg() &#123;  </div><div class="line">      System.out.println(&quot;This is an example RMI program&quot;);  </div><div class="line">   &#125;  </div><div class="line">&#125; </div><div class="line">// 服务端绑定注册暴露给远程调用的方法到注册服务中去</div><div class="line">import java.rmi.registry.Registry; </div><div class="line">import java.rmi.registry.LocateRegistry; </div><div class="line">import java.rmi.RemoteException; </div><div class="line">import java.rmi.server.UnicastRemoteObject; </div><div class="line">public class Server extends ImplExample &#123; </div><div class="line">   public Server() &#123;&#125; </div><div class="line">   public static void main(String args[]) &#123; </div><div class="line">      try &#123; </div><div class="line">         // Instantiating the implementation class </div><div class="line">         ImplExample obj = new ImplExample(); </div><div class="line">    </div><div class="line">         // Exporting the object of implementation class  </div><div class="line">         // (here we are exporting the remote object to the stub) </div><div class="line">         Hello stub = (Hello) UnicastRemoteObject.exportObject(obj, 0);  </div><div class="line">         </div><div class="line">         // Binding the remote object (stub) in the registry </div><div class="line">         Registry registry = LocateRegistry.getRegistry(); </div><div class="line">         // 绑定注册暴露给远程调用的方法，内部采用hashtable数据结构进行存储</div><div class="line">         registry.bind(&quot;Hello&quot;, stub);  </div><div class="line">         System.err.println(&quot;Server ready&quot;); </div><div class="line">      &#125; catch (Exception e) &#123; </div><div class="line">         System.err.println(&quot;Server exception: &quot; + e.toString()); </div><div class="line">         e.printStackTrace(); </div><div class="line">      &#125; </div><div class="line">   &#125; </div><div class="line">&#125; </div><div class="line">// 客户端发起远程调用，远程地址视情况而定</div><div class="line">import java.rmi.registry.LocateRegistry; </div><div class="line">import java.rmi.registry.Registry;  </div><div class="line">public class Client &#123;  </div><div class="line">   private Client() &#123;&#125;  </div><div class="line">   public static void main(String[] args) &#123;  </div><div class="line">      try &#123;  </div><div class="line">         // Getting the registry </div><div class="line">         Registry registry = LocateRegistry.getRegistry(host); </div><div class="line">    </div><div class="line">         // Looking up the registry for the remote object </div><div class="line">         Hello stub = (Hello) registry.lookup(&quot;Hello&quot;); </div><div class="line">    </div><div class="line">         // Calling the remote method using the obtained object </div><div class="line">         stub.printMsg(); </div><div class="line">         </div><div class="line">         // System.out.println(&quot;Remote method invoked&quot;); </div><div class="line">      &#125; catch (Exception e) &#123;</div><div class="line">         System.err.println(&quot;Client exception: &quot; + e.toString()); </div><div class="line">         e.printStackTrace(); </div><div class="line">      &#125; </div><div class="line">   &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><ul>
<li>启动一个监听远程端口服务（默认1099）：负责注册本地方法和提供接受远程方法调用查找功能<ul>
<li>java/bin目录下有脚本文件rmiregister来启动注册服务</li>
<li>RegistryImpl服务端绑定注册/查找暴露方法</li>
<li>RegistryImpl_Stub客户端需要远程连接服务端RegistryImpl调用服务端的方法来实现绑定注册/查找暴露方法等操作</li>
</ul>
</li>
<li>需要暴露给远程的方法需要注册到指定服务上，这样才能被找到</li>
<li>暴露方法的实际存放数据结构：private Hashtable<string, remote=""> bindings = new Hashtable&lt;&gt;(101);</string,></li>
</ul>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><ul>
<li>主要分析RegistryImpl_Stub类，该类是客户端发起远程调用的关键类，包含了tcp连接的建立等重要信息</li>
<li>RegistryImpl_Stub是由LocateRegistry.getRegistry(host)返回</li>
<li>RemoteRef的子类UnicastRef类的newCall方法发起远程调用</li>
<li>newCall方法中由ref.getChannel().newConnection()获取tcp连接</li>
<li>TcpChannel类中newConnection方法会有先从private final List<tcpconnection> freeList = new ArrayList&lt;&gt;();中获取，没有，新建连接</tcpconnection></li>
<li>tcp连接如果开启了重用，则会存入freeList中供下次使用，节省连接创建开销，即使用单一长链接模式</li>
<li>连接模式为：单一长链接模式或者短链接模式<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div></pre></td><td class="code"><pre><div class="line">// LocateRegistry类获取注册中心</div><div class="line">public static Registry getRegistry(String host, int port,RMIClientSocketFactory csf) throws RemoteException&#123;</div><div class="line">    Registry registry = null;</div><div class="line"></div><div class="line">    if (port &lt;= 0)</div><div class="line">        port = Registry.REGISTRY_PORT;</div><div class="line"></div><div class="line">    if (host == null || host.length() == 0) &#123;</div><div class="line">        // If host is blank (as returned by &quot;file:&quot; URL in 1.0.2 used in</div><div class="line">        // java.rmi.Naming), try to convert to real local host name so</div><div class="line">        // that the RegistryImpl&apos;s checkAccess will not fail.</div><div class="line">        try &#123;</div><div class="line">            host = java.net.InetAddress.getLocalHost().getHostAddress();</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            // If that failed, at least try &quot;&quot; (localhost) anyway...</div><div class="line">            host = &quot;&quot;;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /*</div><div class="line">     + Create a proxy for the registry with the given host, port, and</div><div class="line">     + client socket factory.  If the supplied client socket factory is</div><div class="line">     + null, then the ref type is a UnicastRef, otherwise the ref type</div><div class="line">     + is a UnicastRef2.  If the property</div><div class="line">     + java.rmi.server.ignoreStubClasses is true, then the proxy</div><div class="line">     + returned is an instance of a dynamic proxy class that implements</div><div class="line">     + the Registry interface; otherwise the proxy returned is an</div><div class="line">     + instance of the pregenerated stub class for RegistryImpl.</div><div class="line">     **/</div><div class="line">    LiveRef liveRef =</div><div class="line">        new LiveRef(new ObjID(ObjID.REGISTRY_ID),</div><div class="line">                    new TCPEndpoint(host, port, csf, null),</div><div class="line">                    false);</div><div class="line">    RemoteRef ref =</div><div class="line">        (csf == null) ? new UnicastRef(liveRef) : new UnicastRef2(liveRef);</div><div class="line"></div><div class="line">    return (Registry) Util.createProxy(RegistryImpl.class, ref, false);</div><div class="line">&#125;</div><div class="line">@SuppressWarnings(&#123;&quot;deprecation&quot;, &quot;serial&quot;&#125;)</div><div class="line">public final class RegistryImpl_Stub extends java.rmi.server.RemoteStub implements java.rmi.registry.Registry, java.rmi.Remote &#123;</div><div class="line">    // 远程调用服务端注册中心的所有方法列表</div><div class="line">    private static final java.rmi.server.Operation[] operations = &#123;</div><div class="line">            new java.rmi.server.Operation(&quot;void bind(java.lang.String, java.rmi.Remote)&quot;),</div><div class="line">            new java.rmi.server.Operation(&quot;java.lang.String list()[]&quot;),</div><div class="line">            new java.rmi.server.Operation(&quot;java.rmi.Remote lookup(java.lang.String)&quot;),</div><div class="line">            new java.rmi.server.Operation(&quot;void rebind(java.lang.String, java.rmi.Remote)&quot;),</div><div class="line">            new java.rmi.server.Operation(&quot;void unbind(java.lang.String)&quot;)</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    private static final long interfaceHash = 4905912898345647071L;</div><div class="line"></div><div class="line">    // constructors</div><div class="line">    public RegistryImpl_Stub() &#123;</div><div class="line">        super();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public RegistryImpl_Stub(java.rmi.server.RemoteRef ref) &#123;</div><div class="line">        super(ref);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // methods from remote interfaces</div><div class="line"></div><div class="line">    // implementation of bind(String, Remote)</div><div class="line">    public void bind(java.lang.String $param_String_1, java.rmi.Remote $param_Remote_2)</div><div class="line">            throws java.rmi.AccessException, java.rmi.AlreadyBoundException, java.rmi.RemoteException &#123;</div><div class="line">        try &#123;</div><div class="line">            // RemoteRef的子类UnicastRef类的newCall方法发起远程调用</div><div class="line">            StreamRemoteCall call = (StreamRemoteCall)ref.newCall(this, operations, 0, interfaceHash);</div><div class="line">            try &#123;</div><div class="line">                java.io.ObjectOutput out = call.getOutputStream();</div><div class="line">                out.writeObject($param_String_1);</div><div class="line">                out.writeObject($param_Remote_2);</div><div class="line">            &#125; catch (java.io.IOException e) &#123;</div><div class="line">                throw new java.rmi.MarshalException(&quot;error marshalling arguments&quot;, e);</div><div class="line">            &#125;</div><div class="line">            ref.invoke(call);</div><div class="line">            ref.done(call);</div><div class="line">        &#125; catch (java.lang.RuntimeException e) &#123;</div><div class="line">            throw e;</div><div class="line">        &#125; catch (java.rmi.RemoteException e) &#123;</div><div class="line">            throw e;</div><div class="line">        &#125; catch (java.rmi.AlreadyBoundException e) &#123;</div><div class="line">            throw e;</div><div class="line">        &#125; catch (java.lang.Exception e) &#123;</div><div class="line">            throw new java.rmi.UnexpectedException(&quot;undeclared checked exception&quot;, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // implementation of list()</div><div class="line">    public java.lang.String[] list()</div><div class="line">            throws java.rmi.AccessException, java.rmi.RemoteException &#123;</div><div class="line">        try &#123;</div><div class="line">            StreamRemoteCall call = (StreamRemoteCall)ref.newCall(this, operations, 1, interfaceHash);</div><div class="line">            ref.invoke(call);</div><div class="line">            java.lang.String[] $result;</div><div class="line">            try &#123;</div><div class="line">                java.io.ObjectInput in = call.getInputStream();</div><div class="line">                $result = (java.lang.String[]) in.readObject();</div><div class="line">            &#125; catch (ClassCastException | IOException | ClassNotFoundException e) &#123;</div><div class="line">                call.discardPendingRefs();</div><div class="line">                throw new java.rmi.UnmarshalException(&quot;error unmarshalling return&quot;, e);</div><div class="line">            &#125; finally &#123;</div><div class="line">                ref.done(call);</div><div class="line">            &#125;</div><div class="line">            return $result;</div><div class="line">        &#125; catch (java.lang.RuntimeException e) &#123;</div><div class="line">            throw e;</div><div class="line">        &#125; catch (java.rmi.RemoteException e) &#123;</div><div class="line">            throw e;</div><div class="line">        &#125; catch (java.lang.Exception e) &#123;</div><div class="line">            throw new java.rmi.UnexpectedException(&quot;undeclared checked exception&quot;, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // implementation of lookup(String)</div><div class="line">    public java.rmi.Remote lookup(java.lang.String $param_String_1)</div><div class="line">            throws java.rmi.AccessException, java.rmi.NotBoundException, java.rmi.RemoteException &#123;</div><div class="line">        try &#123;</div><div class="line">            StreamRemoteCall call = (StreamRemoteCall)ref.newCall(this, operations, 2, interfaceHash);</div><div class="line">            try &#123;</div><div class="line">                java.io.ObjectOutput out = call.getOutputStream();</div><div class="line">                out.writeObject($param_String_1);</div><div class="line">            &#125; catch (java.io.IOException e) &#123;</div><div class="line">                throw new java.rmi.MarshalException(&quot;error marshalling arguments&quot;, e);</div><div class="line">            &#125;</div><div class="line">            ref.invoke(call);</div><div class="line">            java.rmi.Remote $result;</div><div class="line">            try &#123;</div><div class="line">                java.io.ObjectInput in = call.getInputStream();</div><div class="line">                $result = (java.rmi.Remote) in.readObject();</div><div class="line">            &#125; catch (ClassCastException | IOException | ClassNotFoundException e) &#123;</div><div class="line">                call.discardPendingRefs();</div><div class="line">                throw new java.rmi.UnmarshalException(&quot;error unmarshalling return&quot;, e);</div><div class="line">            &#125; finally &#123;</div><div class="line">                ref.done(call);</div><div class="line">            &#125;</div><div class="line">            return $result;</div><div class="line">        &#125; catch (java.lang.RuntimeException e) &#123;</div><div class="line">            throw e;</div><div class="line">        &#125; catch (java.rmi.RemoteException e) &#123;</div><div class="line">            throw e;</div><div class="line">        &#125; catch (java.rmi.NotBoundException e) &#123;</div><div class="line">            throw e;</div><div class="line">        &#125; catch (java.lang.Exception e) &#123;</div><div class="line">            throw new java.rmi.UnexpectedException(&quot;undeclared checked exception&quot;, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">...</div><div class="line">&#125;</div><div class="line">// UnicastRef类的newCall方法</div><div class="line">public RemoteCall newCall(RemoteObject obj, Operation[] ops, int opnum,long hash) throws RemoteException&#123;</div><div class="line">    clientRefLog.log(Log.BRIEF, &quot;get connection&quot;);</div><div class="line">    // 获取tcp连接</div><div class="line">    Connection conn = ref.getChannel().newConnection();</div><div class="line">    try &#123;</div><div class="line">        clientRefLog.log(Log.VERBOSE, &quot;create call context&quot;);</div><div class="line"></div><div class="line">        /* log information about the outgoing call */</div><div class="line">        if (clientCallLog.isLoggable(Log.VERBOSE)) &#123;</div><div class="line">            logClientCall(obj, ops[opnum]);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        RemoteCall call =</div><div class="line">            new StreamRemoteCall(conn, ref.getObjID(), opnum, hash);</div><div class="line">        try &#123;</div><div class="line">            marshalCustomCallData(call.getOutputStream());</div><div class="line">        &#125; catch (IOException e) &#123;</div><div class="line">            throw new MarshalException(&quot;error marshaling &quot; +</div><div class="line">                                       &quot;custom call data&quot;);</div><div class="line">        &#125;</div><div class="line">        return call;</div><div class="line">    &#125; catch (RemoteException e) &#123;</div><div class="line">        ref.getChannel().free(conn, false);</div><div class="line">        throw e;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">// 获取tcp连接</div><div class="line">public class TCPChannel implements Channel &#123;</div><div class="line">// 默认不使用多路复用</div><div class="line">private boolean usingMultiplexer = false;</div><div class="line">...</div><div class="line">public Connection newConnection() throws RemoteException &#123;</div><div class="line">    TCPConnection conn;</div><div class="line"></div><div class="line">    // loop until we find a free live connection (in which case</div><div class="line">    // we return) or until we run out of freelist (in which case</div><div class="line">    // the loop exits)</div><div class="line">    do &#123;</div><div class="line">        conn = null;</div><div class="line">        // 优先从空闲连接list中获取连接</div><div class="line">        // try to get a free connection</div><div class="line">        synchronized (freeList) &#123;</div><div class="line">            int elementPos = freeList.size()-1;</div><div class="line"></div><div class="line">            if (elementPos &gt;= 0) &#123;</div><div class="line">                // If there is a security manager, make sure</div><div class="line">                // the caller is allowed to connect to the</div><div class="line">                // requested endpoint.</div><div class="line">                checkConnectPermission();</div><div class="line">                conn = freeList.get(elementPos);</div><div class="line">                freeList.remove(elementPos);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // at this point, conn is null iff the freelist is empty,</div><div class="line">        // and nonnull if a free connection of uncertain vitality</div><div class="line">        // has been found.</div><div class="line"></div><div class="line">        if (conn != null) &#123;</div><div class="line">            // 校验链接是否已经失效/不可用/超时断开</div><div class="line">            // check to see if the connection has closed since last use</div><div class="line">            if (!conn.isDead()) &#123;</div><div class="line">                TCPTransport.tcpLog.log(Log.BRIEF, &quot;reuse connection&quot;);</div><div class="line">                return conn;</div><div class="line">            &#125;</div><div class="line">            // 连接不可用时，释放该链接，跳出循环，新建连接</div><div class="line">            // conn is dead, and cannot be reused (reuse =&gt; false)</div><div class="line">            this.free(conn, false);</div><div class="line">        &#125;</div><div class="line">    &#125; while (conn != null);</div><div class="line">    // 没有空闲连接，创建新连接</div><div class="line">    // none free, so create a new connection</div><div class="line">    return (createConnection());</div><div class="line">&#125;</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="分布式垃圾回收-DGC"><a href="#分布式垃圾回收-DGC" class="headerlink" title="分布式垃圾回收-DGC"></a>分布式垃圾回收-DGC</h2><h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h3><ul>
<li>Java虚拟机中，一个远程对象不仅会被本地虚拟机内的变量引用，还会被远程引用。</li>
<li>只有当一个远程对象不受到任何本地引用和远程引用，这个远程对象才会结束生命周期。</li>
<li>服务端的一个远程对象在3个地方被引用：<ul>
<li>服务端的一个本地对象持有它的本地引用</li>
<li>服务端的远程对象已经注册到rmiregistry注册表中，也就是说，rmiregistry注册表持有它的远程引用。</li>
<li>客户端获得远程对象的存根对象，也就是说，客户端持有它的远程引用。</li>
</ul>
</li>
<li>服务端判断客户端是否持有远程对象引用的方法：<ul>
<li>当客户端获得一个服务端的远程对象的存根时，就会向服务器发送一条租约(lease)通知，以告诉服务器自己持有了这个远程对象的引用了。</li>
<li>客户端定期地向服务器发送租约通知，以保证服务器始终都知道客户端一直持有着远程对象的引用。</li>
<li>租约是有期限的，如果租约到期了，服务器则认为客户端已经不再持有远程对象的引用了。</li>
</ul>
</li>
</ul>
<h3 id="实现原理-1"><a href="#实现原理-1" class="headerlink" title="实现原理"></a>实现原理</h3><ul>
<li>在分布式系统中，就像在本地系统中一样，希望自动删除那些不再被任何客户端引用的远程对象。这使程序员无需跟踪远程对象的客户端，以便它可以适当地终止。 RMI 使用类似于 Modula-3 的网络对象的引用计数垃圾收集算法。 （参见 Birrell、Nelson 和 Owicki 的“网络对象”，数字设备公司系统研究中心技术报告 115，1994 年。）</li>
<li>为了完成引用计数垃圾收集，RMI 运行时会跟踪每个 Java 虚拟机中的所有活动引用。当实时引用进入 Java 虚拟机时，其引用计数会增加。对对象的第一次引用将“引用”消息发送到该对象的服务器。由于在本地虚拟机中发现未引用实时引用，因此计数递减。当最后一个引用被丢弃时，一个未引用的消息被发送到服务器。协议中存在许多微妙之处；其中大部分与维护引用和未引用消息的顺序有关，以确保不会过早收集对象。</li>
<li>当远程对象没有被任何客户端引用时，RMI 运行时使用弱引用来引用它。如果不存在对该对象的其他本地引用，弱引用允许 Java 虚拟机的垃圾收集器丢弃该对象。分布式垃圾收集算法通过保持对对象的正常或弱引用，以通常的方式与本地 Java 虚拟机的垃圾收集器交互。</li>
<li>只要对远程对象的本地引用存在，就不能被垃圾收集，并且可以在远程调用中传递或返回给客户端。传递远程对象会将其传递到的虚拟机的标识符添加到引用集。需要未引用通知的远程对象必须实现 java.rmi.server.Unreferenced 接口。当这些引用不再存在时，将调用未引用的方法。当发现引用集为空时调用 unreferenced ，因此它可能会被多次调用。仅当不再存在本地或远程引用时才收集远程对象。</li>
<li>请注意，如果客户端和远程服务器对象之间存在<strong>网络分区</strong>，则可能会发生远程对象的过早收集（因为服务端可能认为客户端崩溃了）。由于有过早收集的可能性，远程引用不能保证引用完整性；换句话说，远程引用总是有可能实际上不引用现有对象。尝试使用此类引用将生成必须由应用程序处理的 RemoteException。</li>
<li>RMI 子系统实现基于引用计数的“分布式垃圾回收”(DGC)，以便为远程服务器对象提供自动内存管理设施。</li>
<li>当客户机创建（序列化）远程引用时，会在服务器端 DGC 上调用dirty()。当客户机完成远程引用后，它会调用对应的clean()方法。</li>
<li>针对远程对象的引用由持有该引用的客户机租用一段时间。租期从收到dirty()调用开始。在此类租约到期之前，客户机必须通过对远程引用额外调用dirty()来更新租约。如果客户机不在租约到期前进行续签，那么分布式垃圾收集器会假设客户机不再引用远程对象。</li>
<li>DGCClient 可实现 RMI 分布式垃圾回收系统的客户机端。DGCClient 的外部接口是registerRefs()方法。 当远程对象的 LiveRef 进入 JVM 时，它必须向 DGCClient 注册以参与分布式垃圾回收。当注册针对特定远程对象的第一个 LiveRef 时，会对远程对象的服务器端 DGC 调用dirty()。该调用会返回租约，保证服务器端 DGC 在特定时间不会回收远程对象。如果存在针对特定服务器上的远程对象的 LiveRef 实例，那么 DGCClient 会定期发送更多的 dirty 调用以续签其租约。DGCClient 将使用虚引用来跟踪已注册 LiveRef 实例的本地可用性。在本地对特定远程对象的 LiveRef 实例进行垃圾回收时，将对服务器端 DGC 调用clean()。该调用表明服务器不需要为此客户机保持活动的远程对象。RenewCleanThread 将通过续签租约并进行 clean 调用来处理异步客户机端 DGC 活动。因此，此线程将一直等待，直至下一次续签租约，或直至有任何虚引用排队以根据需要生成 clean 请求。</li>
</ul>
<h2 id="类比其他语言"><a href="#类比其他语言" class="headerlink" title="类比其他语言"></a>类比其他语言</h2><ul>
<li>c++</li>
<li>php：grpc</li>
<li>golang</li>
</ul>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><ul>
<li>duboo的服务端多个tcp长链接复用如何实现</li>
<li>远程调用是否可以实现调用接口缓存（幂等/非幂等）</li>
<li>除了Socket，RPC还有其他的通信方法，比如：http、操作系统自带的管道等技术来实现对于远程程序的调用。微软的Windows系统中，RPC就是采用命名管道进行通信。</li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="http://op7sipvie.bkt.clouddn.com/wechat-reward-image.JPG" alt="刘飞 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="http://op7sipvie.bkt.clouddn.com/alipay-reward-image.JPG" alt="刘飞 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/JAVA/" rel="tag"># JAVA</a>
          
            <a href="/tags/RMI/" rel="tag"># RMI</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/05/16/数据库连接池/" rel="next" title="数据库连接池">
                <i class="fa fa-chevron-left"></i> 数据库连接池
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="uyan_frame"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="刘飞" />
          <p class="site-author-name" itemprop="name">刘飞</p>
           
              <p class="site-description motion-element" itemprop="description">一只奋进的小菜鸟</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">158</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">60</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">148</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/LFstefan" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#RMI"><span class="nav-number">1.</span> <span class="nav-text">RMI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用样例"><span class="nav-number">1.1.</span> <span class="nav-text">使用样例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现原理"><span class="nav-number">1.2.</span> <span class="nav-text">实现原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码解析"><span class="nav-number">1.3.</span> <span class="nav-text">源码解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式垃圾回收-DGC"><span class="nav-number">1.4.</span> <span class="nav-text">分布式垃圾回收-DGC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基础概念"><span class="nav-number">1.4.1.</span> <span class="nav-text">基础概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现原理-1"><span class="nav-number">1.4.2.</span> <span class="nav-text">实现原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#类比其他语言"><span class="nav-number">1.5.</span> <span class="nav-text">类比其他语言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展"><span class="nav-number">1.6.</span> <span class="nav-text">扩展</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  Sat Apr 29 2017 08:00:00 GMT+0800 (China Standard Time) - 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘飞</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  
    

    
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=https://lfstefan.github.io/"></script>
      <!-- UY END -->
    
  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      $('#local-search-input').focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("4jo3lh32lhNprUWelt3fCUrM-gzGzoHsz", "cTko66LfK5xF0OrYbFlACBB7");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

</body>
</html>
